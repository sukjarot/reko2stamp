<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Reko2stamp-Ultimate (2.5)</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon ultimate.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Inter:wght@400;600&family=Montserrat:wght@500;700&family=Oswald:wght@500&family=Roboto:wght@400;500&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  
  <style>
    /* Fix tampilan control pencarian agar tidak tertutup */
    .leaflet-control-geocoder-form input { color: #000; }
    .leaflet-control-geocoder-icon { background-color: white; border-radius: 4px; }
  </style>
  
  <style>
    :root {
      --bg-app: #0f172a;       
      --bg-panel: #1e293b;     
      --bg-input: #334155;     
      --primary: #3b82f6;
      --danger: #ef4444;       
      --success: #10b981;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --radius: 12px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      margin: 0; font-family: 'Roboto', sans-serif; 
      background: var(--bg-app); color: var(--text-main); overflow: hidden; 
    }

    header { 
      height: 50px; /* Sedikit dipertinggi agar cahaya neon leluasa */
      background: var(--bg-panel); 
      border-bottom: 1px solid #334155;
      display: flex; align-items: center; justify-content: center;
      z-index: 50;
      
      /* --- EFEK NEON FUTURISTIK (VERSI SANS SERIF) --- */
      font-family: 'Montserrat', sans-serif; /* Menggunakan font sans-serif tebal */
      font-weight: 700; /* Wajib tebal (Bold) agar pendaran neon terlihat jelas */
      font-size: 24px;  /* Sedikit disesuaikan agar proporsional */
      color: #e0f2fe;   
      letter-spacing: 1.5px; /* Jarak antar huruf diperlebar agar terlihat mewah */
      text-transform: capitalize;
      
      /* Racikan Bayangan Neon Biru (Cyan) */
      text-shadow: 
          0 0 5px  rgba(6, 182, 212, 0.8),   /* Glow tajam dekat */
          0 0 10px rgba(6, 182, 212, 0.6),   /* Glow menyebar */
          0 0 20px rgba(59, 130, 246, 0.4),  /* Aura biru luar */
          0 0 40px rgba(59, 130, 246, 0.2);  /* Atmosfer redup */
    }

    main { display: flex; flex-direction: row; height: calc(100vh - 50px); }

    .canvas-wrap { 
      flex-grow: 1; position: relative; background: #000; 
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; touch-action: none;
      background-image: radial-gradient(#334155 1px, transparent 1px);
      background-size: 20px 20px; order: 2; 
    }
    canvas { box-shadow: 0 0 40px rgba(0,0,0,0.5); transform-origin: 0 0; }

    .controls { 
      width: 360px; background: var(--bg-panel); padding: 20px; 
      overflow-y: auto; border-right: 1px solid #334155;
      display: flex; flex-direction: column; gap: 16px;
      z-index: 40; order: 1;
    }

    label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; display: block; font-weight: 500; text-transform: uppercase; }

    input[type="text"], input[type="datetime-local"], select, textarea {
      width: 100%; padding: 12px; background: var(--bg-input); 
      border: 1px solid transparent; border-radius: var(--radius); 
      color: white; font-family: inherit; outline: none; font-size: 14px;
    }
    textarea { resize: vertical; min-height: 80px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; }
    input:focus, textarea:focus { border-color: var(--primary); background: #475569; }

    /* LOCATION AUTOCOMPLETE STYLE */
    .location-wrapper { position: relative; }
    .suggestions-list {
      position: absolute; top: 100%; left: 0; right: 0;
      background: #1e293b; border: 1px solid #475569;
      border-radius: 0 0 8px 8px; z-index: 100;
      max-height: 200px; overflow-y: auto;
      display: none; box-shadow: 0 10px 15px rgba(0,0,0,0.5);
    }
    .suggestion-item {
      padding: 10px; font-size: 13px; border-bottom: 1px solid #334155;
      cursor: pointer; color: #e2e8f0;
    }
    .suggestion-item:hover { background: var(--primary); color: white; }
    .gps-btn {
      background: rgba(16, 185, 129, 0.2); color: var(--success);
      border: 1px solid var(--success); padding: 8px 12px;
      border-radius: 6px; font-size: 13px; cursor: pointer;
      font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 4px;
      margin-top: 8px; width: 100%;
    }
    .gps-btn:hover { background: var(--success); color: white; }
    /* --- PENAMBAHAN CSS TOMBOL PETA & GRUP --- */
    .location-btn-group {
      display: flex;
      gap: 10px; /* Jarak antar tombol */
      margin-top: 8px;
    }
    /* Agar kedua tombol berbagi ruang yang sama */
    .location-btn-group .gps-btn, 
    .location-btn-group .map-btn-style {
      flex: 1;
      margin-top: 0 !important; /* Reset margin lama */
    }
    /* Gaya khusus warna biru untuk tombol peta */
    .map-btn-style {
        background: rgba(59, 130, 246, 0.2); color: var(--primary);
        border: 1px solid var(--primary);
        padding: 8px 12px; border-radius: 6px; font-size: 13px; cursor: pointer;
        font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 4px;
        width: 100%;
    }
    .map-btn-style:hover { background: var(--primary); color: white; }
    
    /* CSS untuk tombol close di dalam modal peta */
    .close-map-overlay-btn {
      position: absolute; top: 20px; right: 20px; z-index: 10001;
      background: rgba(0,0,0,0.6); color: white; border: none;
      width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer;
    }
    /* --- AKHIR PENAMBAHAN CSS --- */

    /* TOGGLE SWITCH */
    .toggle-row {
        display: flex; justify-content: space-between; align-items: center;
        background: var(--bg-input); padding: 8px 12px; border-radius: var(--radius);
        margin-bottom: 8px;
    }
    .toggle-label { margin: 0; font-size: 0.85rem; color: white; text-transform: none; }
    .switch { position: relative; display: inline-block; width: 42px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #64748b; transition: .4s; border-radius: 24px;
    }
    .slider:before {
      position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(18px); }

    /* SLIDERS */
    .slider-container { background: var(--bg-input); padding: 10px; border-radius: var(--radius); }
    .slider-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
    .slider-group { display: flex; align-items: center; gap: 8px; }
    .btn-adjust {
      width: 30px; height: 30px; background: #475569; border: none; border-radius: 50%;
      color: white; cursor: pointer; display: grid; place-items: center; font-weight: bold;
    }
    input[type=range] { flex-grow: 1; height: 4px; background: #1e293b; border-radius: 2px; -webkit-appearance: none; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; border: 2px solid white; cursor: pointer;
    }

    /* BUTTONS */
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button.main-btn {
      padding: 14px; border: none; border-radius: var(--radius); font-weight: 600;
      cursor: pointer; font-size: 0.9rem; color: white; transition: 0.2s;
    }
    button.main-btn:active { transform: scale(0.96); }
    .btn-secondary { background: #334155; }
    .btn-primary { background: var(--primary); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    .btn-danger { background: var(--danger); }
    .file-btn {
      background: linear-gradient(45deg, #3b82f6, #6366f1);
      padding: 12px; border-radius: var(--radius); text-align: center; cursor: pointer; font-weight: 600;
      display: block; width: 100%;
    }

    @media (max-width: 768px) {
      main { flex-direction: column; }
      .canvas-wrap { order: 1; height: 45vh; width: 100%; border-bottom: 1px solid #334155; }
      .controls { 
        order: 2; height: 55vh; width: 100%; border-right: none; 
        border-top: 1px solid #334155; border-radius: 20px 20px 0 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.4); padding-bottom: 80px; 
      }
    }

    /* CSS KAMERA */
    .input-group-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;
    }
    .camera-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; z-index: 9999;
      display: none; flex-direction: column;
    }
    .camera-view {
      flex-grow: 1; width: 100%; height: 100%; object-fit: cover;
      background: #000; transition: transform 0.3s ease;
    }
    .camera-controls {
      position: absolute; bottom: 30px; left: 0; width: 100%;
      display: flex; justify-content: space-around; align-items: center;
      padding: 0 20px;
    }
    .shutter-btn {
      width: 70px; height: 70px; border-radius: 50%;
      background: white; border: 4px solid rgba(255,255,255,0.3);
      cursor: pointer; transition: 0.2s;
    }
    .shutter-btn:active { transform: scale(0.9); background: #eee; }
    .cam-action-btn {
      background: rgba(255,255,255,0.2); border: none; color: white;
      padding: 12px; border-radius: 50%; cursor: pointer;
      font-size: 1.2rem; width: 50px; height: 50px;
      display: flex; align-items: center; justify-content: center;
    }
    .cam-action-btn:hover { background: rgba(255,255,255,0.4); }
    .btn-camera {
      background: linear-gradient(45deg, #059669, #10b981);
      color: white; font-weight: 600; border-radius: var(--radius);
      border: none; cursor: pointer; display: flex; align-items: center; 
      justify-content: center; gap: 6px;
    }
  </style>
</head>
<body>

  <header>Reko2stamp-Ultimate (2.5)</header>

  <main>
    <aside class="controls">
      <div class="input-group-row">
        <label class="file-btn" style="margin:0; display:flex; align-items:center; justify-content:center; gap:5px;">
          üìÇ Galeri
          <input type="file" id="fileInput" accept="image/*" style="display: none;"/>
        </label>
        <button id="openCameraBtn" class="btn-camera">üì∑ Foto</button>
      </div>

      <div>
        <label>Pengaturan Waktu</label>
        <div class="toggle-row">
            <span class="toggle-label">Tampilkan Tanggal & Jam</span>
            <label class="switch">
                <input type="checkbox" id="showDateToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
        <input type="datetime-local" id="dtInput"/>
      </div>

      <div>
        <label>Lokasi / Catatan</label>
        <div class="location-wrapper">
            <textarea id="locInput" rows="3" placeholder="Ketik lokasi atau klik tombol GPS..."></textarea>
            <div id="suggestions" class="suggestions-list"></div>
        </div>
        <div class="location-btn-group">
            <button id="gpsBtn" class="gps-btn" title="Gunakan Lokasi Saat Ini">
                üìç Cek GPS
            </button>
            <button id="mapBtn" class="map-btn-style" title="Lihat Peta">
                üó∫Ô∏è Cek Peta
            </button>
        </div>

      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
        <div>
          <label>Font</label>
          <select id="fontSelect">
            <option value="Roboto">Roboto</option>
            <option value="Montserrat">Montserrat</option>
            <option value="Oswald">Oswald Bold</option>
            <option value="Share Tech Mono">Digital</option>
            <option value="Great Vibes">Signature</option>
          </select>
        </div>
        <div>
           <label>Warna</label>
           <input type="color" id="fontColor" value="#ffffff" style="height: 44px; padding: 2px;">
        </div>
      </div>

      <div>
        <label>Ukuran Teks</label>
        <div class="slider-container">
            <div class="slider-header"><span>Size</span><span id="sizeVal">80px</span></div>
            <div class="slider-group">
                <button class="btn-adjust" onclick="adjustSize(-5)">-</button>
                <input type="range" id="sizeSlider" min="20" max="300" value="80" step="5">
                <button class="btn-adjust" onclick="adjustSize(5)">+</button>
            </div>
        </div>
      </div>

      <div>
        <label>Transparansi</label>
        <div class="slider-container">
            <div class="slider-header"><span>Opacity</span><span id="opacityVal">90%</span></div>
            <div class="slider-group">
                <input type="range" id="opacitySlider" min="0" max="100" step="5" value="90">
            </div>
        </div>
      </div>

      <div class="action-grid" style="grid-template-columns: 1fr 1fr 1fr;">
        <button id="resetView" class="main-btn btn-secondary" style="padding: 10px; font-size: 0.8rem;">‚Ü∫ Reset</button>
        <button id="rotateBtn" class="main-btn btn-secondary" style="padding: 10px; font-size: 0.8rem;">‚§µ Putar</button>
        <button id="toggleCrop" class="main-btn btn-secondary" style="padding: 10px; font-size: 0.8rem;">‚úÇ Potong</button>
      </div>

      <button id="clearBtn" class="main-btn btn-danger" style="margin-top: 10px; margin-bottom: 10px;">üóë Hapus Foto</button>

      <button id="downloadFinal" class="main-btn btn-primary">‚¨á Simpan (Max 4MB)</button>
    </aside>

    <section class="canvas-wrap" id="canvasContainer">
      <canvas id="canvas"></canvas>
    </section>
  </main>
  
  <div id="cameraModal" class="camera-modal">
    <video id="cameraVideo" class="camera-view" autoplay playsinline></video>
    
    <div class="camera-controls">
      <button id="closeCamBtn" class="cam-action-btn" title="Tutup">‚ùå</button>
      <button id="rotateCamBtn" class="cam-action-btn" title="Putar Kamera">‚§µÔ∏è</button>
      <button id="shutterBtn" class="shutter-btn" title="Ambil Foto"></button>
      <button id="switchCamBtn" class="cam-action-btn" title="Ganti Kamera">üîÑ</button>
    </div>
  </div>
  
  <script>
    // --- PENDAFTARAN SERVICE WORKER (PWA) ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker terdaftar!', reg.scope))
                .catch(err => console.log('Gagal daftar Service Worker:', err));
        });
    }
    
    // --- 1. INISIALISASI VARIABEL GLOBAL ---
    // --- MASUKKAN TOKEN DARI LOCATIONIQ DI SINI ---
    const LOCATIONIQ_KEY = 'pk.9415d0e1f42e8b4c9b6d9be7be2f5108';
    const fileInput = document.getElementById('fileInput');
    const dtInput = document.getElementById('dtInput');
    const showDateToggle = document.getElementById('showDateToggle');
    const locInput = document.getElementById('locInput');
    const gpsBtn = document.getElementById('gpsBtn');
    const suggestionsBox = document.getElementById('suggestions');

    const sizeSlider = document.getElementById('sizeSlider');
    const sizeValDisplay = document.getElementById('sizeVal');
    const opacitySlider = document.getElementById('opacitySlider');
    const opacityValDisplay = document.getElementById('opacityVal');
    const fontColor = document.getElementById('fontColor');
    const fontSelect = document.getElementById('fontSelect');
    
    const resetViewBtn = document.getElementById('resetView');
    const toggleCropBtn = document.getElementById('toggleCrop');
    const clearBtn = document.getElementById('clearBtn');
    const rotateBtn = document.getElementById('rotateBtn');
    const downloadFinalBtn = document.getElementById('downloadFinal');
    const canvasContainer = document.getElementById('canvasContainer');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // SISTEM BARU
    let sourceImage = null; 
    let isUsingCanvasSource = false; 
    let imgLoaded = false;
    let isNewFile = false;

    // States Touch/UI
    let viewScale = 1; let viewX = 0; let viewY = 0;
    
    // Stamp State
    let stampX = 50, stampY = 100;
    let draggingStamp = false; 
    
    // Crop State
    let cropMode = false; 
    let cropRect = null; 
    let cropAction = null; 
    let dragStartPos = {x:0, y:0};
    let initialCropRect = null; 

    // Pinch Zoom State
    let initialPinchDist = 0; let initialScale = 1; let lastPanX = 0; let lastPanY = 0;
    let isDrawing = false; 

    const MAX_DIMENSION = 4096;
    const MAX_FILE_SIZE = 4 * 1024 * 1024;
    
    // --- SETTING UKURAN HANDLE (UPDATED FOR MOBILE) ---
    const VISUAL_HANDLE_SIZE = 30; // Ukuran kotak biru yang terlihat (px)
    const TOUCH_HANDLE_SIZE = 80;  // Area sentuh invisible (Sangat besar agar mudah kena jempol)

    // Init Date
    const now = new Date();
    const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    dtInput.value = localIso;

    // --- 2. HELPER RENDERING ---
    function requestRender() {
        if (!isDrawing) {
            isDrawing = true;
            requestAnimationFrame(() => {
                draw();
                isDrawing = false;
            });
        }
    }

    function getSourceWidth() {
        if (!sourceImage) return 0;
        return isUsingCanvasSource ? sourceImage.width : sourceImage.naturalWidth;
    }

    function getSourceHeight() {
        if (!sourceImage) return 0;
        return isUsingCanvasSource ? sourceImage.height : sourceImage.naturalHeight;
    }

    // --- 3. LOGIKA UTAMA (DRAW & CANVAS) ---
    function updateTransform() { 
        canvas.style.transform = `translate(${viewX}px, ${viewY}px) scale(${viewScale})`; 
    }

    function draw() {
        if (!imgLoaded || !sourceImage) { 
            canvas.width = 300; canvas.height = 300;
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,300,300);
            ctx.fillStyle = '#64748b'; ctx.font = '16px Roboto'; ctx.textAlign = 'center';
            ctx.fillText('Pilih Foto Dulu', 150, 150);
            return; 
        }
        
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);

        // Render Text / Stamp
        const text = buildStampText();
        const fSize = parseInt(sizeSlider.value);
        const alpha = parseInt(opacitySlider.value) / 100;
        
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.font = `bold ${fSize}px "${fontSelect.value}"`; 
        ctx.fillStyle = fontColor.value || '#fff';
        ctx.textAlign = 'left';
        
        const shadowSize = Math.max(2, fSize / 15);
        ctx.shadowColor = `rgba(0,0,0,${alpha})`;
        ctx.shadowBlur = shadowSize; ctx.shadowOffsetX = shadowSize/2; ctx.shadowOffsetY = shadowSize/2;

        wrapText(text, stampX, stampY, canvas.width - (stampX + 20), fSize * 1.25);
        ctx.restore();

        // --- RENDER CROP UI ---
        if (cropMode && cropRect) {
            ctx.save();
            
            // Dimming Area Luar
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.rect(cropRect.x, cropRect.y, cropRect.w, cropRect.h); 
            ctx.clip("evenodd"); 
            ctx.fill();

            // Garis Batas
            ctx.strokeStyle = 'rgba(0,0,0,0.5)'; ctx.lineWidth = 4 / viewScale; ctx.setLineDash([]);
            ctx.strokeRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);
            ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 2 / viewScale; ctx.setLineDash([12, 6]);
            ctx.strokeRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);

            // HANDLES (Visual Box)
            ctx.setLineDash([]);
            // Kita pakai VISUAL_HANDLE_SIZE di sini agar tampilan tetap rapi (tidak terlalu besar)
            const vHandle = VISUAL_HANDLE_SIZE / viewScale; 
            const halfH = vHandle / 2;
            
            ctx.fillStyle = '#3b82f6'; ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 2 / viewScale;

            const drawH = (cx, cy) => {
                ctx.beginPath();
                ctx.rect(cx - halfH, cy - halfH, vHandle, vHandle);
                ctx.fill(); ctx.stroke();
            };

            const l = cropRect.x; const cX = cropRect.x + cropRect.w / 2; const r = cropRect.x + cropRect.w;
            const t = cropRect.y; const cY = cropRect.y + cropRect.h / 2; const b = cropRect.y + cropRect.h;

            drawH(l, t); drawH(cX, t); drawH(r, t);
            drawH(r, cY); drawH(r, b); drawH(cX, b);
            drawH(l, b); drawH(l, cY);

            // Grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; ctx.lineWidth = 1 / viewScale; ctx.beginPath();
            ctx.moveTo(cropRect.x + cropRect.w/3, cropRect.y); ctx.lineTo(cropRect.x + cropRect.w/3, cropRect.y + cropRect.h);
            ctx.moveTo(cropRect.x + 2*cropRect.w/3, cropRect.y); ctx.lineTo(cropRect.x + 2*cropRect.w/3, cropRect.y + cropRect.h);
            ctx.moveTo(cropRect.x, cropRect.y + cropRect.h/3); ctx.lineTo(cropRect.x + cropRect.w, cropRect.y + cropRect.h/3);
            ctx.moveTo(cropRect.x, cropRect.y + 2*cropRect.h/3); ctx.lineTo(cropRect.x + cropRect.w, cropRect.y + 2*cropRect.h/3);
            ctx.stroke();

            ctx.restore();
        }
    }

    function buildStampText() {
        let text = '';
        if (showDateToggle.checked) {
            const dt = new Date(dtInput.value);
            if(!isNaN(dt)) {
                const pad = n => n.toString().padStart(2, '0');
                text += `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
            }
        }
        const loc = locInput.value.trim();
        if (loc) { if (text) text += '\n'; text += loc; }
        return text;
    }

    function wrapText(text, x, y, maxWidth, lineHeight) {
        const lines = text.split('\n');
        for (let i = 0; i < lines.length; i++) { ctx.fillText(lines[i], x, y + (i * lineHeight)); }
    }

    function setupHighResCanvas() {
        if (!sourceImage) return;
        let w = getSourceWidth();
        let h = getSourceHeight();
        if (w > MAX_DIMENSION || h > MAX_DIMENSION) {
            const ratio = w / h;
            if (w > h) { w = MAX_DIMENSION; h = Math.round(w / ratio); } 
            else { h = MAX_DIMENSION; w = Math.round(h * ratio); }
        }
        canvas.width = w; canvas.height = h;

        const padding = 20; 
        const isMobile = window.innerWidth < 768;
        const screenW = isMobile ? (window.innerWidth - padding) : (window.innerWidth - 380);
        const screenH = isMobile ? (window.innerHeight * 0.40) : (window.innerHeight - 80);
        const ratio = w / h;
        let cssW = screenW; let cssH = cssW / ratio;
        if (cssH > screenH) { cssH = screenH; cssW = cssH * ratio; }
        canvas.style.width = `${cssW}px`; canvas.style.height = `${cssH}px`;
        
        if(isNewFile) { 
            viewScale = 1; viewX = 0; viewY = 0; updateTransform(); 
            stampX = canvas.width * 0.05; 
            stampY = canvas.height - (canvas.height * 0.1); 
            const autoSize = Math.max(40, Math.round(canvas.width * 0.04));
            sizeSlider.value = autoSize; 
            sizeValDisplay.textContent = autoSize + 'px';
            isNewFile = false;
        }
        draw();
    }

    // --- 4. INTERAKSI TOUCH (UPDATED HIT REGION) ---
    
    function getHitRegion(x, y) {
        if (!cropRect) return null;
        
        // PENGATURAN TOLERANSI SENTUH (SANGAT PENTING UNTUK HP)
        // Kita pakai TOUCH_HANDLE_SIZE agar area deteksinya luas
        const hitSize = (TOUCH_HANDLE_SIZE / viewScale); 
        const halfHit = hitSize / 2;
        
        const l = cropRect.x;
        const cX = cropRect.x + cropRect.w / 2;
        const r = cropRect.x + cropRect.w;
        const t = cropRect.y;
        const cY = cropRect.y + cropRect.h / 2;
        const b = cropRect.y + cropRect.h;

        // Cek apakah koordinat (x,y) masuk dalam kotak imajiner handle
        const check = (tx, ty) => {
            return (x >= tx - halfHit && x <= tx + halfHit && y >= ty - halfHit && y <= ty + halfHit);
        };

        if (check(l, t)) return 'nw';
        if (check(cX, t)) return 'n';
        if (check(r, t)) return 'ne';
        
        if (check(r, cY)) return 'e';
        if (check(r, b)) return 'se';
        
        if (check(cX, b)) return 's';
        if (check(l, b)) return 'sw';
        if (check(l, cY)) return 'w';

        // Cek Move (Badan)
        if (x > l && x < r && y > t && y < b) return 'move';

        return null;
    }

    function getDist(touches) { return Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY); }
    function getPos(clientX, clientY) {
        const rect = canvas.getBoundingClientRect(); 
        const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
        return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
    }

    // --- FUNGSI BARU: HIT DETECTION LEBIH BAIK UNTUK STAMP TEKS ---
  function getTextBoundingBox() {
      if (!imgLoaded || !sourceImage) return null;

      const text = buildStampText();
      if (!text.trim()) return null;

      const fSize = parseInt(sizeSlider.value);
      const lines = text.split('\n');
      const lineHeight = fSize * 1.25;

      // Sementara set font untuk measureText
      ctx.font = `bold ${fSize}px "${fontSelect.value}"`;

      let maxWidth = 0;
      lines.forEach(line => {
          const metrics = ctx.measureText(line);
          if (metrics.width > maxWidth) maxWidth = metrics.width;
      });

      const textWidth = maxWidth;
      const textHeight = lines.length * lineHeight;

      // Bounding box (actualBounds tanpa shadow)
      return {
          x: stampX,
          y: stampY - fSize, // karena fillText mulai dari baseline atas
          w: textWidth,
          h: textHeight
      };
  }

  function isPointInTextArea(posX, posY) {
      const bbox = getTextBoundingBox();
      if (!bbox) return false;

      // Padding besar untuk kemudahan sentuh (40px di semua sisi)
      const padding = 40;

      return (
          posX >= bbox.x - padding &&
          posX <= bbox.x + bbox.w + padding &&
          posY >= bbox.y - padding &&
          posY <= bbox.y + bbox.h + padding
      );
  }

  // --- PERBAIKAN HANDLE START (drag stamp lebih leluasa) ---
  function handleStart(clientX, clientY) {
      const pos = getPos(clientX, clientY);
      dragStartPos = pos;

      if (cropMode) {
          const hit = getHitRegion(pos.x, pos.y);
          if (hit) {
              cropAction = hit;
              initialCropRect = { ...cropRect };
          } else {
              cropAction = 'create';
              cropRect = { x: pos.x, y: pos.y, w: 0, h: 0 };
          }
      } else {
          // PERBAIKAN: Deteksi drag stamp berdasarkan bounding box teks + padding
          if (isPointInTextArea(pos.x, pos.y)) {
              draggingStamp = true;
              // Offset agar posisi cursor tetap konsisten saat drag
              const bbox = getTextBoundingBox();
              if (bbox) {
                  dragStartPos.offsetX = pos.x - stampX;
                  dragStartPos.offsetY = pos.y - (stampY - parseInt(sizeSlider.value));
              }
          }
      }
  }

  function handleMove(clientX, clientY) {
      const pos = getPos(clientX, clientY);

      if (cropMode && cropAction) {
          if (cropAction === 'create') {
              cropRect.w = pos.x - dragStartPos.x;
              cropRect.h = pos.y - dragStartPos.y;
          } 
          else if (cropAction === 'move') {
              const dx = pos.x - dragStartPos.x;
              const dy = pos.y - dragStartPos.y;
              cropRect.x = initialCropRect.x + dx;
              cropRect.y = initialCropRect.y + dy;
          } 
          else {
              const dx = pos.x - dragStartPos.x;
              const dy = pos.y - dragStartPos.y;
              const i = initialCropRect;

              if (cropAction.includes('n')) { cropRect.y = i.y + dy; cropRect.h = i.h - dy; }
              if (cropAction.includes('s')) { cropRect.h = i.h + dy; }
              if (cropAction.includes('w')) { cropRect.x = i.x + dx; cropRect.w = i.w - dx; }
              if (cropAction.includes('e')) { cropRect.w = i.w + dx; }
          }
          requestRender();
      } 
      else if (draggingStamp) {
          // PERBAIKAN: Gunakan offset agar grip tidak "snap" ke kiri
          if (dragStartPos.offsetX !== undefined) {
              stampX = pos.x - dragStartPos.offsetX;
              stampY = pos.y - dragStartPos.offsetY + parseInt(sizeSlider.value); // kompensasi baseline
          } else {
              stampX = pos.x;
              stampY = pos.y;
          }
          requestRender();
      }
  }

  // handleEnd tetap sama
  function handleEnd() {
      if (cropMode && cropRect) {
          if (cropRect.w < 0) { cropRect.x += cropRect.w; cropRect.w = Math.abs(cropRect.w); }
          if (cropRect.h < 0) { cropRect.y += cropRect.h; cropRect.h = Math.abs(cropRect.h); }
      }
      cropAction = null; 
      draggingStamp = false; 
      initialCropRect = null;
      // Reset offset
      delete dragStartPos.offsetX;
      delete dragStartPos.offsetY;
  }

    // --- EVENT LISTENERS ---
    canvasContainer.addEventListener('touchstart', (e) => {
        if(!imgLoaded) return;
        if (e.touches.length === 2) {
            e.preventDefault();
            initialPinchDist = getDist(e.touches); initialScale = viewScale;
            lastPanX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            lastPanY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
        } else if (e.touches.length === 1) {
            handleStart(e.touches[0].clientX, e.touches[0].clientY);
        }
    }, {passive: false});

    canvasContainer.addEventListener('touchmove', (e) => {
        if(!imgLoaded) return;
        e.preventDefault(); 
        if (e.touches.length === 2) {
            const currentDist = getDist(e.touches);
            const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            const newScale = initialScale * (currentDist / initialPinchDist);
            viewScale = Math.min(Math.max(0.1, newScale), 10); 
            const dx = centerX - lastPanX; const dy = centerY - lastPanY;
            viewX += dx; viewY += dy; lastPanX = centerX; lastPanY = centerY; updateTransform();
        } else if (e.touches.length === 1) {
            handleMove(e.touches[0].clientX, e.touches[0].clientY);
        }
    }, {passive: false});

    canvasContainer.addEventListener('touchend', handleEnd);

    // MOUSE
    canvasContainer.addEventListener('mousedown', (e) => { if(!imgLoaded) return; handleStart(e.clientX, e.clientY); });
    window.addEventListener('mousemove', (e) => { if(!imgLoaded) return; if (e.buttons === 1) handleMove(e.clientX, e.clientY); });
    window.addEventListener('mouseup', handleEnd);


    // --- 5. INPUT FILE & LAINNYA ---
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        isNewFile = true; const reader = new FileReader();
        reader.onload = (ev) => {
            const tempImg = new Image();
            tempImg.onload = () => { sourceImage = tempImg; isUsingCanvasSource = false; imgLoaded = true; setupHighResCanvas(); };
            tempImg.src = ev.target.result;
        }; reader.readAsDataURL(file);
    });

    // KAMERA
    const openCameraBtn = document.getElementById('openCameraBtn');
    const cameraModal = document.getElementById('cameraModal');
    const cameraVideo = document.getElementById('cameraVideo');
    const closeCamBtn = document.getElementById('closeCamBtn');
    const shutterBtn = document.getElementById('shutterBtn');
    const switchCamBtn = document.getElementById('switchCamBtn');
    const rotateCamBtn = document.getElementById('rotateCamBtn');
    let currentStream = null; let facingMode = 'environment'; let currentRotation = 0; 

    openCameraBtn.addEventListener('click', async () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert("Browser error."); return; }
        await startCamera();
    });
    async function startCamera() {
        if (currentStream) stopCamera(); updateVideoStyle();
        try {
            currentStream = await navigator.mediaDevices.getUserMedia({video: { facingMode: facingMode, width: {ideal:4096}, height: {ideal:2160} }});
            cameraVideo.srcObject = currentStream; cameraModal.style.display = 'flex';
        } catch (err) { alert("Gagal akses kamera."); cameraModal.style.display = 'none'; }
    }
    function stopCamera() { if (currentStream) { currentStream.getTracks().forEach(t => t.stop()); currentStream = null; } cameraVideo.srcObject = null; }
    closeCamBtn.addEventListener('click', () => { stopCamera(); cameraModal.style.display = 'none'; });
    switchCamBtn.addEventListener('click', () => { facingMode = (facingMode==='environment')?'user':'environment'; startCamera(); });
    rotateCamBtn.addEventListener('click', () => { currentRotation = (currentRotation+90)%360; updateVideoStyle(); });
    function updateVideoStyle() {
        let t = `rotate(${currentRotation}deg)`; if(facingMode==='user') t+=` scaleX(-1)`;
        cameraVideo.style.transform = t; cameraVideo.style.objectFit=(currentRotation%180!==0)?"contain":"cover";
    }
    shutterBtn.addEventListener('click', () => {
        if(!currentStream) return;
        const vW = cameraVideo.videoWidth; const vH = cameraVideo.videoHeight;
        const tC = document.createElement('canvas'); const ctxT = tC.getContext('2d');
        if(currentRotation%180!==0) { tC.width=vH; tC.height=vW; } else { tC.width=vW; tC.height=vH; }
        ctxT.translate(tC.width/2, tC.height/2); ctxT.rotate(currentRotation*Math.PI/180);
        if(facingMode==='user') ctxT.scale(-1,1);
        ctxT.drawImage(cameraVideo, -vW/2, -vH/2, vW, vH);
        sourceImage = tC; isUsingCanvasSource=true; imgLoaded=true; isNewFile=true;
        stopCamera(); cameraModal.style.display='none'; setupHighResCanvas();
        const n = new Date(); dtInput.value=new Date(n-n.getTimezoneOffset()*60000).toISOString().slice(0,16);
    });

    // ROTATE
    rotateBtn.addEventListener('click', () => {
        if(!imgLoaded || !sourceImage) return;
        const origT = rotateBtn.textContent; rotateBtn.textContent = '‚è≥'; 
        requestAnimationFrame(() => {
            const w = getSourceWidth(); const h = getSourceHeight();
            const tC = document.createElement('canvas'); tC.width = h; tC.height = w;
            const xT = tC.getContext('2d');
            xT.translate(tC.width/2, tC.height/2); xT.rotate(90*Math.PI/180);
            xT.drawImage(sourceImage, -w/2, -h/2);
            sourceImage = tC; isUsingCanvasSource = true;
            setupHighResCanvas();
            if(cropMode) { cropRect = null; cropAction=null; toggleCropBtn.textContent='‚úÇ Potong'; toggleCropBtn.classList.remove('btn-danger'); toggleCropBtn.classList.add('btn-secondary'); cropMode=false; }
            draw(); rotateBtn.textContent = origT;
        });
    });

    // CROP BUTTON
    toggleCropBtn.addEventListener('click', () => {
        if (cropMode) {
            if (cropRect && cropRect.w > 10 && cropRect.h > 10) applyCrop();
            cropMode = false;
            toggleCropBtn.textContent = '‚úÇ Potong';
            toggleCropBtn.classList.remove('btn-danger'); toggleCropBtn.classList.add('btn-secondary');
        } else {
            cropMode = true; 
            const cw = canvas.width; const ch = canvas.height;
            cropRect = { x: cw*0.1, y: ch*0.1, w: cw*0.8, h: ch*0.8 };
            toggleCropBtn.textContent = '‚úÖ Terapkan';
            toggleCropBtn.classList.remove('btn-secondary'); toggleCropBtn.classList.add('btn-danger');
        }
        draw();
    });

    function applyCrop() {
        if (!sourceImage || !cropRect) return;
        const x = cropRect.w < 0 ? cropRect.x + cropRect.w : cropRect.x;
        const y = cropRect.h < 0 ? cropRect.y + cropRect.h : cropRect.y;
        const w = Math.abs(cropRect.w);
        const h = Math.abs(cropRect.h);
        const tC = document.createElement('canvas'); tC.width = w; tC.height = h;
        const tX = tC.getContext('2d');
        tX.drawImage(sourceImage, x, y, w, h, 0, 0, w, h);
        sourceImage = tC; isUsingCanvasSource = true; setupHighResCanvas();
    }

    // ============================================================
    // PERBAIKAN FITUR PETA & GPS (FINAL SINKRON)
    // ============================================================
    
    // Variabel Global khusus Peta
    let mapInstance = null;
    let mapMarker = null;
    let currentLat = -7.605, currentLon = 111.905; // Koordinat default

    // 1. FUNGSI AMBIL ALAMAT (REVERSE GEOCODING)
    async function updateAddressField(lat, lon) {
        locInput.value = "‚è≥ Mengambil alamat...";
        requestRender();

        try {
            const url = `https://us1.locationiq.com/v1/reverse.php?key=${LOCATIONIQ_KEY}&lat=${lat}&lon=${lon}&format=json`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            // Perapi Alamat (Ambil 4 bagian pertama)
            let parts = data.display_name.split(',');
            let cleanAddress = parts.slice(0, 4).join(',').trim();
            
            locInput.value = `${cleanAddress}\n(${lat.toFixed(5)}, ${lon.toFixed(5)})`;
        } catch (e) {
            locInput.value = `Lokasi: (${lat.toFixed(5)}, ${lon.toFixed(5)})`;
        }
        requestRender();
    }

    // 2. LOGIKA TOMBOL GPS
    gpsBtn.addEventListener('click', () => {
        if (!navigator.geolocation) return alert("GPS tidak didukung");
        
        gpsBtn.innerHTML = "‚è≥ Mencari...";
        navigator.geolocation.getCurrentPosition(async (p) => {
            currentLat = p.coords.latitude;
            currentLon = p.coords.longitude;
            
            await updateAddressField(currentLat, currentLon);
            gpsBtn.innerHTML = "üìç Cek GPS";
            
            // Update posisi marker jika peta sedang terbuka
            if (mapInstance) {
                mapInstance.setView([currentLat, currentLon], 16);
                if (mapMarker) mapMarker.setLatLng([currentLat, currentLon]);
            }
        }, (err) => {
            alert("Gagal akses GPS. Pastikan izin lokasi aktif.");
            gpsBtn.innerHTML = "üìç Cek GPS";
        }, { enableHighAccuracy: true });
    });

    // 3. LOGIKA PETA INTERAKTIF
    const mapModal = document.getElementById('mapModal');
    const closeMapBtn = document.getElementById('closeMapBtn');

    function initLeafletMap() {
        if (mapInstance) return; // Jangan inisialisasi ulang

        mapInstance = L.map('mapContainer').setView([currentLat, currentLon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);

        // Tambah fitur Search (Pencarian)
        const geocoder = L.Control.geocoder({ defaultMarkGeocode: false })
            .on('markgeocode', function(e) {
                const bbox = e.geocode.center;
                selectAndClose(bbox.lat, bbox.lng);
            })
            .addTo(mapInstance);

        // Klik pada peta untuk pilih lokasi
        mapInstance.on('click', (e) => {
            selectAndClose(e.latlng.lat, e.latlng.lng);
        });
    }

    function selectAndClose(lat, lon) {
        currentLat = lat;
        currentLon = lon;
        
        if (mapMarker) mapMarker.setLatLng([lat, lon]);
        else mapMarker = L.marker([lat, lon]).addTo(mapInstance);

        if (confirm("Pilih lokasi ini?")) {
            mapModal.style.display = 'none';
            updateAddressField(lat, lon);
        }
    }

    // Tombol Buka Peta
    document.getElementById('mapBtn').addEventListener('click', () => {
        mapModal.style.display = 'flex';
        
        // PENTING: Timeout agar peta tampil sempurna (tidak abu-abu)
        setTimeout(() => {
            initLeafletMap();
            mapInstance.invalidateSize(); // Reset ukuran canvas peta
            mapInstance.setView([currentLat, currentLon], 15);
            
            if (mapMarker) mapMarker.setLatLng([currentLat, currentLon]);
            else mapMarker = L.marker([currentLat, currentLon]).addTo(mapInstance);
        }, 300);
    });

    closeMapBtn.addEventListener('click', () => {
        mapModal.style.display = 'none';
    });
							
</script>
html
  <div id="mapModal" class="camera-modal" style="z-index: 10000; background: #1e293b;">
    <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column;">
       
       <div style="padding: 10px; display:flex; justify-content:space-between; align-items:center; background:#0f172a; border-bottom: 1px solid #334155;">
          <span style="font-weight: bold; color: white;">Pilih Lokasi di Peta</span>
          <button id="closeMapBtn" style="background:transparent; border:none; color:white; font-size:1.5rem; cursor:pointer;">‚ùå</button>
       </div>

       <div id="mapContainer" style="flex-grow: 1; width: 100%; background: #ddd;"></div>
       
       <div style="padding:8px; background:#0f172a; text-align:center; font-size:12px; color:#94a3b8;">
         üîç Cari lokasi atau üëÜ Klik di peta untuk memilih tempat.
       </div>
    </div>
  </div>
</body>
</html>




