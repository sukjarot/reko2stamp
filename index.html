<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Reko2stamp-Ultimate (2.4)</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon ultimate.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Inter:wght@400;600&family=Montserrat:wght@500;700&family=Oswald:wght@500&family=Roboto:wght@400;500&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-app: #0f172a;       
      --bg-panel: #1e293b;     
      --bg-input: #334155;     
      --primary: #3b82f6;
      --danger: #ef4444;       
      --success: #10b981;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --radius: 12px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      margin: 0; font-family: 'Roboto', sans-serif; 
      background: var(--bg-app); color: var(--text-main); overflow: hidden; 
    }

    header { 
      height: 50px; /* Sedikit dipertinggi agar cahaya neon leluasa */
      background: var(--bg-panel); 
      border-bottom: 1px solid #334155;
      display: flex; align-items: center; justify-content: center;
      z-index: 50;
      
      /* --- EFEK NEON FUTURISTIK (VERSI SANS SERIF) --- */
      font-family: 'Montserrat', sans-serif; /* Menggunakan font sans-serif tebal */
      font-weight: 700; /* Wajib tebal (Bold) agar pendaran neon terlihat jelas */
      font-size: 24px;  /* Sedikit disesuaikan agar proporsional */
      color: #e0f2fe;   
      letter-spacing: 1.5px; /* Jarak antar huruf diperlebar agar terlihat mewah */
      text-transform: capitalize;
      
      /* Racikan Bayangan Neon Biru (Cyan) */
      text-shadow: 
          0 0 5px  rgba(6, 182, 212, 0.8),   /* Glow tajam dekat */
          0 0 10px rgba(6, 182, 212, 0.6),   /* Glow menyebar */
          0 0 20px rgba(59, 130, 246, 0.4),  /* Aura biru luar */
          0 0 40px rgba(59, 130, 246, 0.2);  /* Atmosfer redup */
    }

    main { display: flex; flex-direction: row; height: calc(100vh - 50px); }

    .canvas-wrap { 
      flex-grow: 1; position: relative; background: #000; 
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; touch-action: none;
      background-image: radial-gradient(#334155 1px, transparent 1px);
      background-size: 20px 20px; order: 2; 
    }
    canvas { box-shadow: 0 0 40px rgba(0,0,0,0.5); transform-origin: 0 0; }

    .controls { 
      width: 360px; background: var(--bg-panel); padding: 20px; 
      overflow-y: auto; border-right: 1px solid #334155;
      display: flex; flex-direction: column; gap: 16px;
      z-index: 40; order: 1;
    }

    label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; display: block; font-weight: 500; text-transform: uppercase; }

    input[type="text"], input[type="datetime-local"], select, textarea {
      width: 100%; padding: 12px; background: var(--bg-input); 
      border: 1px solid transparent; border-radius: var(--radius); 
      color: white; font-family: inherit; outline: none; font-size: 14px;
    }
    textarea { resize: vertical; min-height: 80px; line-height: 1.5; }
    input:focus, textarea:focus { border-color: var(--primary); background: #475569; }

    /* LOCATION AUTOCOMPLETE STYLE */
    .location-wrapper { position: relative; }
    .suggestions-list {
      position: absolute; top: 100%; left: 0; right: 0;
      background: #1e293b; border: 1px solid #475569;
      border-radius: 0 0 8px 8px; z-index: 100;
      max-height: 200px; overflow-y: auto;
      display: none; box-shadow: 0 10px 15px rgba(0,0,0,0.5);
    }
    .suggestion-item {
      padding: 10px; font-size: 13px; border-bottom: 1px solid #334155;
      cursor: pointer; color: #e2e8f0;
    }
    .suggestion-item:hover { background: var(--primary); color: white; }
    .gps-btn {
      position: absolute; right: 8px; top: 8px;
      background: rgba(16, 185, 129, 0.2); color: var(--success);
      border: 1px solid var(--success); padding: 4px 8px;
      border-radius: 6px; font-size: 11px; cursor: pointer;
      font-weight: bold; display: flex; align-items: center; gap: 4px;
    }
    .gps-btn:hover { background: var(--success); color: white; }

    /* TOGGLE SWITCH */
    .toggle-row {
        display: flex; justify-content: space-between; align-items: center;
        background: var(--bg-input); padding: 8px 12px; border-radius: var(--radius);
        margin-bottom: 8px;
    }
    .toggle-label { margin: 0; font-size: 0.85rem; color: white; text-transform: none; }
    .switch { position: relative; display: inline-block; width: 42px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #64748b; transition: .4s; border-radius: 24px;
    }
    .slider:before {
      position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(18px); }

    /* SLIDERS */
    .slider-container { background: var(--bg-input); padding: 10px; border-radius: var(--radius); }
    .slider-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
    .slider-group { display: flex; align-items: center; gap: 8px; }
    .btn-adjust {
      width: 30px; height: 30px; background: #475569; border: none; border-radius: 50%;
      color: white; cursor: pointer; display: grid; place-items: center; font-weight: bold;
    }
    input[type=range] { flex-grow: 1; height: 4px; background: #1e293b; border-radius: 2px; -webkit-appearance: none; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; border: 2px solid white; cursor: pointer;
    }

    /* BUTTONS */
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button.main-btn {
      padding: 14px; border: none; border-radius: var(--radius); font-weight: 600;
      cursor: pointer; font-size: 0.9rem; color: white; transition: 0.2s;
    }
    button.main-btn:active { transform: scale(0.96); }
    .btn-secondary { background: #334155; }
    .btn-primary { background: var(--primary); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    .btn-danger { background: var(--danger); }
    .file-btn {
      background: linear-gradient(45deg, #3b82f6, #6366f1);
      padding: 12px; border-radius: var(--radius); text-align: center; cursor: pointer; font-weight: 600;
      display: block; width: 100%;
    }

    @media (max-width: 768px) {
      main { flex-direction: column; }
      .canvas-wrap { order: 1; height: 45vh; width: 100%; border-bottom: 1px solid #334155; }
      .controls { 
        order: 2; height: 55vh; width: 100%; border-right: none; 
        border-top: 1px solid #334155; border-radius: 20px 20px 0 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.4); padding-bottom: 80px; 
      }
    }

    /* CSS KAMERA */
    .input-group-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;
    }
    .camera-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; z-index: 9999;
      display: none; flex-direction: column;
    }
    .camera-view {
      flex-grow: 1; width: 100%; height: 100%; object-fit: cover;
      background: #000; transition: transform 0.3s ease;
    }
    .camera-controls {
      position: absolute; bottom: 30px; left: 0; width: 100%;
      display: flex; justify-content: space-around; align-items: center;
      padding: 0 20px;
    }
    .shutter-btn {
      width: 70px; height: 70px; border-radius: 50%;
      background: white; border: 4px solid rgba(255,255,255,0.3);
      cursor: pointer; transition: 0.2s;
    }
    .shutter-btn:active { transform: scale(0.9); background: #eee; }
    .cam-action-btn {
      background: rgba(255,255,255,0.2); border: none; color: white;
      padding: 12px; border-radius: 50%; cursor: pointer;
      font-size: 1.2rem; width: 50px; height: 50px;
      display: flex; align-items: center; justify-content: center;
    }
    .cam-action-btn:hover { background: rgba(255,255,255,0.4); }
    .btn-camera {
      background: linear-gradient(45deg, #059669, #10b981);
      color: white; font-weight: 600; border-radius: var(--radius);
      border: none; cursor: pointer; display: flex; align-items: center; 
      justify-content: center; gap: 6px;
    }
  </style>
</head>
<body>

  <header>Reko2stamp-Ultimate (2.4)</header>

  <main>
    <aside class="controls">
      <div class="input-group-row">
        <label class="file-btn" style="margin:0; display:flex; align-items:center; justify-content:center; gap:5px;">
          üìÇ Galeri
          <input type="file" id="fileInput" accept="image/*" style="display: none;"/>
        </label>
        <button id="openCameraBtn" class="btn-camera">üì∑ Foto</button>
      </div>

      <div>
        <label>Pengaturan Waktu</label>
        <div class="toggle-row">
            <span class="toggle-label">Tampilkan Tanggal & Jam</span>
            <label class="switch">
                <input type="checkbox" id="showDateToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
        <input type="datetime-local" id="dtInput"/>
      </div>

      <div>
        <label>Lokasi / Catatan</label>
        <div class="location-wrapper">
            <textarea id="locInput" rows="3" placeholder="Ketik lokasi atau klik tombol GPS..."></textarea>
            
            <button id="gpsBtn" class="gps-btn" title="Gunakan Lokasi Saat Ini">
                üìç Cek GPS
            </button>

            <div id="suggestions" class="suggestions-list"></div>
        </div>
        <div style="font-size: 10px; color: #64748b; margin-top: 4px;">*By OpenStreetMap</div>
      </div>

      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
        <div>
          <label>Font</label>
          <select id="fontSelect">
            <option value="Roboto">Roboto</option>
            <option value="Montserrat">Montserrat</option>
            <option value="Oswald">Oswald Bold</option>
            <option value="Share Tech Mono">Digital</option>
            <option value="Great Vibes">Signature</option>
          </select>
        </div>
        <div>
           <label>Warna</label>
           <input type="color" id="fontColor" value="#ffffff" style="height: 44px; padding: 2px;">
        </div>
      </div>

      <div>
        <label>Ukuran Teks</label>
        <div class="slider-container">
            <div class="slider-header"><span>Size</span><span id="sizeVal">80px</span></div>
            <div class="slider-group">
                <button class="btn-adjust" onclick="adjustSize(-5)">-</button>
                <input type="range" id="sizeSlider" min="20" max="300" value="80" step="5">
                <button class="btn-adjust" onclick="adjustSize(5)">+</button>
            </div>
        </div>
      </div>

      <div>
        <label>Transparansi</label>
        <div class="slider-container">
            <div class="slider-header"><span>Opacity</span><span id="opacityVal">90%</span></div>
            <div class="slider-group">
                <input type="range" id="opacitySlider" min="0" max="100" step="5" value="90">
            </div>
        </div>
      </div>

      <div class="action-grid" style="grid-template-columns: 1fr 1fr 1fr;">
        <button id="resetView" class="main-btn btn-secondary" style="padding: 10px; font-size: 0.8rem;">‚Ü∫ Reset</button>
        <button id="rotateBtn" class="main-btn btn-secondary" style="padding: 10px; font-size: 0.8rem;">‚§µ Putar</button>
        <button id="toggleCrop" class="main-btn btn-secondary" style="padding: 10px; font-size: 0.8rem;">‚úÇ Potong</button>
      </div>

      <button id="clearBtn" class="main-btn btn-danger" style="margin-top: 10px; margin-bottom: 10px;">üóë Hapus Foto</button>

      <button id="downloadFinal" class="main-btn btn-primary">‚¨á Simpan (Max 4MB)</button>
    </aside>

    <section class="canvas-wrap" id="canvasContainer">
      <canvas id="canvas"></canvas>
    </section>
  </main>
  
  <div id="cameraModal" class="camera-modal">
    <video id="cameraVideo" class="camera-view" autoplay playsinline></video>
    
    <div class="camera-controls">
      <button id="closeCamBtn" class="cam-action-btn" title="Tutup">‚ùå</button>
      <button id="rotateCamBtn" class="cam-action-btn" title="Putar Kamera">‚§µÔ∏è</button>
      <button id="shutterBtn" class="shutter-btn" title="Ambil Foto"></button>
      <button id="switchCamBtn" class="cam-action-btn" title="Ganti Kamera">üîÑ</button>
    </div>
  </div>
  <script>
    // --- 1. INISIALISASI VARIABEL GLOBAL ---
    const fileInput = document.getElementById('fileInput');
    const dtInput = document.getElementById('dtInput');
    const showDateToggle = document.getElementById('showDateToggle');
    const locInput = document.getElementById('locInput');
    const gpsBtn = document.getElementById('gpsBtn');
    const suggestionsBox = document.getElementById('suggestions');

    const sizeSlider = document.getElementById('sizeSlider');
    const sizeValDisplay = document.getElementById('sizeVal');
    const opacitySlider = document.getElementById('opacitySlider');
    const opacityValDisplay = document.getElementById('opacityVal');
    const fontColor = document.getElementById('fontColor');
    const fontSelect = document.getElementById('fontSelect');
    
    const resetViewBtn = document.getElementById('resetView');
    const toggleCropBtn = document.getElementById('toggleCrop');
    const clearBtn = document.getElementById('clearBtn');
    const rotateBtn = document.getElementById('rotateBtn');
    const downloadFinalBtn = document.getElementById('downloadFinal');
    const canvasContainer = document.getElementById('canvasContainer');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // SISTEM BARU (OPTIMIZED)
    let sourceImage = null; // Bisa berupa Image Object atau Canvas Element
    let isUsingCanvasSource = false; // True jika hasil edit/kamera (Canvas), False jika file asli (Image)
    let imgLoaded = false;
    let isNewFile = false;

    // States Touch/UI
    let viewScale = 1; let viewX = 0; let viewY = 0;
    let stampX = 50, stampY = 100;
    let draggingStamp = false; let dragStart = {x:0, y:0};
    let cropMode = false; let cropStart = null; let cropRect = null;
    let initialPinchDist = 0; let initialScale = 1; let lastPanX = 0; let lastPanY = 0;
    let isDrawing = false; // Untuk requestAnimationFrame

    const MAX_DIMENSION = 4096;
    const MAX_FILE_SIZE = 4 * 1024 * 1024;

    // Init Date
    const now = new Date();
    const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    dtInput.value = localIso;

    // --- 2. HELPER RENDERING (ANTI-LAG) ---
    function requestRender() {
        if (!isDrawing) {
            isDrawing = true;
            requestAnimationFrame(() => {
                draw();
                isDrawing = false;
            });
        }
    }

    // Helper untuk mendapatkan dimensi gambar sumber dengan aman
    function getSourceWidth() {
        if (!sourceImage) return 0;
        return isUsingCanvasSource ? sourceImage.width : sourceImage.naturalWidth;
    }

    function getSourceHeight() {
        if (!sourceImage) return 0;
        return isUsingCanvasSource ? sourceImage.height : sourceImage.naturalHeight;
    }

    // --- 3. LOGIKA UTAMA (DRAW & CANVAS) ---
    function updateTransform() { 
        canvas.style.transform = `translate(${viewX}px, ${viewY}px) scale(${viewScale})`; 
    }

    function draw() {
        if (!imgLoaded || !sourceImage) { 
            canvas.width = 300; canvas.height = 300;
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,300,300);
            ctx.fillStyle = '#64748b'; ctx.font = '16px Roboto'; ctx.textAlign = 'center';
            ctx.fillText('Pilih Foto Dulu', 150, 150);
            return; 
        }
        
        // Bersihkan canvas
        ctx.clearRect(0,0,canvas.width,canvas.height);
        
        // Gambar foto utama (Source Image)
        ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);

        // Render Text / Stamp
        const text = buildStampText();
        const fSize = parseInt(sizeSlider.value);
        const alpha = parseInt(opacitySlider.value) / 100;
        
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.font = `bold ${fSize}px "${fontSelect.value}"`; 
        ctx.fillStyle = fontColor.value || '#fff';
        ctx.textAlign = 'left';
        
        const shadowSize = Math.max(2, fSize / 15);
        ctx.shadowColor = `rgba(0,0,0,${alpha})`;
        ctx.shadowBlur = shadowSize; ctx.shadowOffsetX = shadowSize/2; ctx.shadowOffsetY = shadowSize/2;

        wrapText(text, stampX, stampY, canvas.width - (stampX + 20), fSize * 1.25);
        ctx.restore();

        // Render Crop UI (Garis putus-putus)
        if (cropMode && cropRect) {
            ctx.save();
            ctx.strokeStyle = '#ef4444'; ctx.lineWidth = (canvas.width / 200) / viewScale; 
            ctx.setLineDash([20, 10]);
            ctx.strokeRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.beginPath(); ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.rect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);
            ctx.clip("evenodd"); ctx.fill();
            ctx.restore();
        }
    }

    function buildStampText() {
        let text = '';
        if (showDateToggle.checked) {
            const dt = new Date(dtInput.value);
            if(!isNaN(dt)) {
                const pad = n => n.toString().padStart(2, '0');
                text += `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
            }
        }
        const loc = locInput.value.trim();
        if (loc) { if (text) text += '\n'; text += loc; }
        return text;
    }

    function wrapText(text, x, y, maxWidth, lineHeight) {
        const lines = text.split('\n');
        for (let i = 0; i < lines.length; i++) { ctx.fillText(lines[i], x, y + (i * lineHeight)); }
    }

    function setupHighResCanvas() {
        if (!sourceImage) return;

        let w = getSourceWidth();
        let h = getSourceHeight();

        // Downscale jika terlalu besar (untuk performa)
        if (w > MAX_DIMENSION || h > MAX_DIMENSION) {
            const ratio = w / h;
            if (w > h) { w = MAX_DIMENSION; h = Math.round(w / ratio); } 
            else { h = MAX_DIMENSION; w = Math.round(h * ratio); }
        }
        
        // Set ukuran fisik canvas
        canvas.width = w; canvas.height = h;

        // Set ukuran tampilan CSS (Responsif)
        const padding = 20; 
        const isMobile = window.innerWidth < 768;
        const screenW = isMobile ? (window.innerWidth - padding) : (window.innerWidth - 380);
        const screenH = isMobile ? (window.innerHeight * 0.40) : (window.innerHeight - 80);
        const ratio = w / h;
        let cssW = screenW; let cssH = cssW / ratio;
        if (cssH > screenH) { cssH = screenH; cssW = cssH * ratio; }
        canvas.style.width = `${cssW}px`; canvas.style.height = `${cssH}px`;
        
        // Reset posisi view jika file baru
        if(isNewFile) { 
            viewScale = 1; viewX = 0; viewY = 0; updateTransform(); 
            // Reset posisi stamp
            stampX = canvas.width * 0.05; 
            stampY = canvas.height - (canvas.height * 0.1); 
            const autoSize = Math.max(40, Math.round(canvas.width * 0.04));
            sizeSlider.value = autoSize; 
            sizeValDisplay.textContent = autoSize + 'px';
            isNewFile = false;
        }
        draw();
    }

    // --- 4. INPUT FILE & KAMERA ---
    
    // INPUT FILE
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        isNewFile = true;
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            const tempImg = new Image();
            tempImg.onload = () => {
                sourceImage = tempImg; 
                isUsingCanvasSource = false;
                imgLoaded = true;
                setupHighResCanvas();
            };
            tempImg.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    });

    // FITUR KAMERA
    const openCameraBtn = document.getElementById('openCameraBtn');
    const cameraModal = document.getElementById('cameraModal');
    const cameraVideo = document.getElementById('cameraVideo');
    const closeCamBtn = document.getElementById('closeCamBtn');
    const shutterBtn = document.getElementById('shutterBtn');
    const switchCamBtn = document.getElementById('switchCamBtn');
    const rotateCamBtn = document.getElementById('rotateCamBtn');

    let currentStream = null;
    let facingMode = 'environment'; 
    let currentRotation = 0; 

    openCameraBtn.addEventListener('click', async () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("Browser tidak mendukung akses kamera."); return;
        }
        await startCamera();
    });

    async function startCamera() {
        if (currentStream) stopCamera();
        updateVideoStyle();
        const constraints = {
            video: { facingMode: facingMode, width: { ideal: 4096 }, height: { ideal: 2160 } },
            audio: false
        };
        try {
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraVideo.srcObject = currentStream;
            cameraModal.style.display = 'flex';
        } catch (err) {
            alert("Gagal akses kamera: " + err.message);
            cameraModal.style.display = 'none';
        }
    }

    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
        cameraVideo.srcObject = null;
    }

    closeCamBtn.addEventListener('click', () => { stopCamera(); cameraModal.style.display = 'none'; });
    switchCamBtn.addEventListener('click', () => { facingMode = (facingMode === 'environment') ? 'user' : 'environment'; startCamera(); });
    rotateCamBtn.addEventListener('click', () => { currentRotation = (currentRotation + 90) % 360; updateVideoStyle(); });

    function updateVideoStyle() {
        let transform = `rotate(${currentRotation}deg)`;
        if (facingMode === 'user') transform += ` scaleX(-1)`;
        cameraVideo.style.transform = transform;
        cameraVideo.style.objectFit = (currentRotation % 180 !== 0) ? "contain" : "cover";
    }

    shutterBtn.addEventListener('click', () => {
        if (!currentStream) return;
        const vW = cameraVideo.videoWidth;
        const vH = cameraVideo.videoHeight;
        
        const tempCanvas = document.createElement('canvas');
        const ctxT = tempCanvas.getContext('2d');

        if (currentRotation % 180 !== 0) {
            tempCanvas.width = vH; tempCanvas.height = vW;
        } else {
            tempCanvas.width = vW; tempCanvas.height = vH;
        }

        ctxT.translate(tempCanvas.width / 2, tempCanvas.height / 2);
        ctxT.rotate(currentRotation * Math.PI / 180);
        if (facingMode === 'user') ctxT.scale(-1, 1);
        ctxT.drawImage(cameraVideo, -vW / 2, -vH / 2, vW, vH);
        
        // UPDATE SOURCE KE HASIL FOTO (PERBAIKAN UTAMA)
        sourceImage = tempCanvas;
        isUsingCanvasSource = true;
        imgLoaded = true;
        isNewFile = true;
        
        stopCamera();
        cameraModal.style.display = 'none';
        
        setupHighResCanvas();
        
        // Update jam
        const nowClick = new Date();
        dtInput.value = new Date(nowClick - (nowClick.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    });

    // --- 5. FITUR EDIT (ROTATE & CROP) ---

    // ROTATE (OPTIMIZED)
    rotateBtn.addEventListener('click', () => {
        if(!imgLoaded || !sourceImage) return;

        const originalText = rotateBtn.textContent;
        rotateBtn.textContent = '‚è≥'; 

        requestAnimationFrame(() => {
            const w = getSourceWidth();
            const h = getSourceHeight();
            
            const tempC = document.createElement('canvas');
            tempC.width = h; tempC.height = w;
            const ctxT = tempC.getContext('2d');

            ctxT.translate(tempC.width / 2, tempC.height / 2);
            ctxT.rotate(90 * Math.PI / 180);
            ctxT.drawImage(sourceImage, -w / 2, -h / 2);

            // JADIKAN HASIL ROTASI SEBAGAI SOURCE BARU
            sourceImage = tempC; 
            isUsingCanvasSource = true;

            setupHighResCanvas(); // Re-setup canvas size
            
            if (cropMode) { cropMode = false; toggleCropBtn.textContent = '‚úÇ Potong'; toggleCropBtn.classList.remove('btn-danger'); toggleCropBtn.classList.add('btn-secondary'); }

            draw();
            rotateBtn.textContent = originalText;
        });
    });

    // CROP
    toggleCropBtn.addEventListener('click', () => {
        if (cropMode) {
            if (cropRect && cropRect.w > 50 && cropRect.h > 50) applyCrop();
            cropMode = false;
            toggleCropBtn.textContent = '‚úÇ Potong';
            toggleCropBtn.classList.remove('btn-danger'); toggleCropBtn.classList.add('btn-secondary');
        } else {
            cropMode = true; cropRect = null;
            toggleCropBtn.textContent = '‚úÖ Terapkan';
            toggleCropBtn.classList.remove('btn-secondary'); toggleCropBtn.classList.add('btn-danger');
        }
        draw();
    });

    function applyCrop() {
        if (!sourceImage) return;
        const tempC = document.createElement('canvas');
        tempC.width = cropRect.w; tempC.height = cropRect.h;
        const tCtx = tempC.getContext('2d');
        
        const scaleX = canvas.width / canvas.getBoundingClientRect().width * viewScale; 
        // Note: Kalkulasi crop pada mode zoom/pan manual agak kompleks.
        // Kita gunakan pendekatan simple: crop koordinat visual canvas
        
        // Reset scale view dulu agar akurat saat crop
        // Cara terbaik: Crop berdasarkan koordinat Canvas asli
        tCtx.drawImage(canvas, cropRect.x, cropRect.y, cropRect.w, cropRect.h, 0, 0, tempC.width, tempC.height);
        
        // Karena kita crop HASIL canvas (termasuk teks), kita harus hati-hati.
        // Versi "Reko" biasanya ingin crop gambar aslinya saja, tapi ini ribet di UX.
        // Solusi stabil: Crop Gambar Sumber
        
        const realTemp = document.createElement('canvas');
        realTemp.width = cropRect.w; realTemp.height = cropRect.h;
        const rCtx = realTemp.getContext('2d');
        
        // Gambar source original ke posisi crop
        // Karena cropRect dalam koordinat Canvas saat ini:
        rCtx.drawImage(sourceImage, cropRect.x, cropRect.y, cropRect.w, cropRect.h, 0, 0, cropRect.w, cropRect.h);
        
        sourceImage = realTemp;
        isUsingCanvasSource = true;
        setupHighResCanvas();
    }

    // --- 6. EVENT LISTENERS LAINNYA ---
    
    // GPS
    gpsBtn.addEventListener('click', () => {
        if (!navigator.geolocation) { alert("Browser tidak mendukung GPS."); return; }
        const originalText = gpsBtn.innerHTML;
        gpsBtn.innerHTML = "‚è≥ Mencari...";
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                const addr = data.address;
                const street = addr.road || addr.village || addr.suburb || '';
                const city = addr.city || addr.town || addr.county || '';
                const state = addr.state || '';
                locInput.value = `${street}\n${city}, ${state}\n(Titik Koordinat: ${lat.toFixed(5)}, ${lon.toFixed(5)})`;
                draw();
            } catch (err) { alert("Gagal mengambil alamat."); } 
            finally { gpsBtn.innerHTML = originalText; }
        }, (err) => { alert("Gagal akses GPS."); gpsBtn.innerHTML = originalText; });
    });

    // Auto Complete Lokasi
    let debounceTimer;
    locInput.addEventListener('input', (e) => {
        requestRender(); 
        const query = e.target.value.split('\n')[0];
        if (query.length < 3) { suggestionsBox.style.display = 'none'; return; }
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                const results = await res.json();
                if (results.length > 0) {
                    suggestionsBox.innerHTML = '';
                    results.forEach(place => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = place.display_name;
                        div.onclick = () => { locInput.value = place.display_name; suggestionsBox.style.display = 'none'; requestRender(); };
                        suggestionsBox.appendChild(div);
                    });
                    suggestionsBox.style.display = 'block';
                } else { suggestionsBox.style.display = 'none'; }
            } catch (err) {}
        }, 500);
    });
    document.addEventListener('click', (e) => { if (!e.target.closest('.location-wrapper')) suggestionsBox.style.display = 'none'; });

    // Slider & Inputs
    window.adjustSize = (amount) => {
        let val = parseInt(sizeSlider.value); val += amount;
        if (val < parseInt(sizeSlider.min)) val = parseInt(sizeSlider.min);
        if (val > parseInt(sizeSlider.max)) val = parseInt(sizeSlider.max);
        sizeSlider.value = val; sizeValDisplay.textContent = val + 'px'; requestRender();
    };
    sizeSlider.addEventListener('input', () => { sizeValDisplay.textContent = sizeSlider.value + 'px'; requestRender(); });
    opacitySlider.addEventListener('input', () => { opacityValDisplay.textContent = opacitySlider.value + '%'; requestRender(); });
    [dtInput, fontColor, fontSelect, showDateToggle].forEach(el => el.addEventListener('input', requestRender));
    window.addEventListener('resize', () => { if(sourceImage) setupHighResCanvas(); });

    resetViewBtn.addEventListener('click', () => {
        if(imgLoaded) {
            viewScale = 1; viewX = 0; viewY = 0; updateTransform();
            stampX = canvas.width * 0.05; stampY = canvas.height - (canvas.height * 0.1); 
            draw();
        }
    });

    clearBtn.addEventListener('click', () => {
        if (!imgLoaded) return;
        if (confirm('Yakin ingin menghapus foto dari canvas?')) {
            sourceImage = null; imgLoaded = false; isNewFile = false;
            fileInput.value = ''; cropMode = false; cropRect = null;
            toggleCropBtn.textContent = '‚úÇ Potong';
            toggleCropBtn.classList.remove('btn-danger'); toggleCropBtn.classList.add('btn-secondary');
            draw(); 
        }
    });

    // --- 7. TOUCH / MOUSE CONTROLS ---
    function getDist(touches) { return Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY); }
    function getPos(clientX, clientY) {
        const rect = canvas.getBoundingClientRect(); 
        const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
        return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
    }

    canvasContainer.addEventListener('touchstart', (e) => {
        if(!imgLoaded) return;
        if (e.touches.length === 2) {
            e.preventDefault();
            initialPinchDist = getDist(e.touches); initialScale = viewScale;
            lastPanX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            lastPanY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
        } else if (e.touches.length === 1) {
            const pos = getPos(e.touches[0].clientX, e.touches[0].clientY);
            if (!cropMode) {
                const fSize = parseInt(sizeSlider.value);
                if (pos.x >= stampX - fSize && pos.x <= stampX + (fSize*10) && pos.y >= stampY - fSize && pos.y <= stampY + (fSize*2)) {
                    draggingStamp = true; dragStart = { x: pos.x - stampX, y: pos.y - stampY };
                }
            } else {
                cropStart = pos; cropRect = { x: pos.x, y: pos.y, w: 0, h: 0 };
            }
        }
    }, {passive: false});

    canvasContainer.addEventListener('touchmove', (e) => {
        if(!imgLoaded) return;
        e.preventDefault(); 
        if (e.touches.length === 2) {
            const currentDist = getDist(e.touches);
            const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            const newScale = initialScale * (currentDist / initialPinchDist);
            viewScale = Math.min(Math.max(0.1, newScale), 10); 
            const dx = centerX - lastPanX; const dy = centerY - lastPanY;
            viewX += dx; viewY += dy; lastPanX = centerX; lastPanY = centerY; updateTransform();
        } else if (e.touches.length === 1) {
            const pos = getPos(e.touches[0].clientX, e.touches[0].clientY);
            if (draggingStamp) {
                stampX = pos.x - dragStart.x; stampY = pos.y - dragStart.y; requestRender();
            } else if (cropMode && cropStart) {
                const curX = Math.max(0, Math.min(pos.x, canvas.width));
                const curY = Math.max(0, Math.min(pos.y, canvas.height));
                cropRect = {
                    x: Math.min(cropStart.x, curX), y: Math.min(cropStart.y, curY),
                    w: Math.abs(curX - cropStart.x), h: Math.abs(curY - cropStart.y)
                };
                requestRender();
            }
        }
    }, {passive: false});

    canvasContainer.addEventListener('mousedown', (e) => {
        if(!imgLoaded) return;
        const pos = getPos(e.clientX, e.clientY);
        if (!cropMode) {
            const fSize = parseInt(sizeSlider.value);
            if (pos.x >= stampX - fSize && pos.x <= stampX + (fSize*10) && pos.y >= stampY - fSize && pos.y <= stampY + (fSize*2)) {
                draggingStamp = true; dragStart = { x: pos.x - stampX, y: pos.y - stampY };
            }
        } else {
            cropStart = pos; cropRect = { x: pos.x, y: pos.y, w: 0, h: 0 };
        }
    });
    window.addEventListener('mousemove', (e) => {
        if(!imgLoaded) return;
        const pos = getPos(e.clientX, e.clientY);
        if (draggingStamp) { stampX = pos.x - dragStart.x; stampY = pos.y - dragStart.y; requestRender(); } 
        else if (cropMode && cropStart) {
            cropRect = { x: Math.min(cropStart.x, pos.x), y: Math.min(cropStart.y, pos.y), w: Math.abs(pos.x - cropStart.x), h: Math.abs(pos.y - cropStart.y) };
            requestRender();
        }
    });
    window.addEventListener('mouseup', () => { draggingStamp = false; cropStart = null; });
    window.addEventListener('touchend', () => { draggingStamp = false; cropStart = null; });

    // --- 8. DOWNLOAD ---
    downloadFinalBtn.addEventListener('click', () => {
        if(!imgLoaded) return;
        draw();
        const originalText = downloadFinalBtn.textContent;
        downloadFinalBtn.textContent = '‚è≥ Memproses (Max 4MB)...';
        downloadFinalBtn.disabled = true;

        compressImage(1.0);

        function compressImage(quality) {
            canvas.toBlob((blob) => {
                if (blob.size > MAX_FILE_SIZE && quality > 0.1) {
                    compressImage(quality - 0.05);
                } else {
                    downloadBlob(blob);
                    downloadFinalBtn.textContent = originalText;
                    downloadFinalBtn.disabled = false;
                }
            }, 'image/jpeg', quality);
        }
    });

    function downloadBlob(blob) {
        const link = document.createElement('a');
        link.download = `Stamp_${Date.now()}.jpg`;
        link.href = URL.createObjectURL(blob);
        link.click();
        setTimeout(() => URL.revokeObjectURL(link.href), 1000);
    }
    
    // Init Draw
    draw();
</script>
</body>
</html>






