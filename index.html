<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Reko2stamp-Super (2.7)</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon.png">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Inter:wght@400;600&family=Montserrat:wght@500;700&family=Oswald:wght@500&family=Roboto:wght@400;500&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN/RANEjZfcMRS98UlpzSzCiqTBLAJXwY=" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.85.1/dist/L.Control.Locate.min.css" />
  
  <style>
    :root {
      --bg-app: #0f172a;       
      --bg-panel: #1e293b;     
      --bg-input: #334155;     
      --primary: #3b82f6;
      --danger: #ef4444;       
      --success: #10b981;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --radius: 12px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      margin: 0; font-family: 'Roboto', sans-serif; 
      background: var(--bg-app); color: var(--text-main); overflow: hidden; 
    }

    header { 
      height: 50px; 
      background: var(--bg-panel); 
      border-bottom: 1px solid #334155;
      display: flex; align-items: center; justify-content: center;
      z-index: 50;
      
      font-family: 'Montserrat', sans-serif; 
      font-weight: 700; 
      font-size: 20px;  
      color: #e0f2fe;   
      letter-spacing: 1px; 
      text-transform: capitalize;
      
      text-shadow: 
          0 0 5px  rgba(6, 182, 212, 0.8),   
          0 0 10px rgba(6, 182, 212, 0.6);  
    }

    main { display: flex; flex-direction: row; height: calc(100vh - 50px); }

    .canvas-wrap { 
      flex-grow: 1; position: relative; background: #000; 
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; touch-action: none;
      background-image: radial-gradient(#334155 1px, transparent 1px);
      background-size: 20px 20px; order: 2; 
    }
    canvas { box-shadow: 0 0 40px rgba(0,0,0,0.5); max-width: 100%; max-height: 100%; }

    .controls { 
      width: 360px; background: var(--bg-panel); padding: 20px; 
      overflow-y: auto; border-right: 1px solid #334155;
      display: flex; flex-direction: column; gap: 16px;
      z-index: 40; order: 1;
    }

    label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; display: block; font-weight: 500; text-transform: uppercase; }

    input[type="text"], input[type="datetime-local"], select, textarea {
      width: 100%; padding: 10px; background: var(--bg-input); 
      border: 1px solid transparent; border-radius: var(--radius); 
      color: white; font-family: inherit; outline: none; font-size: 14px;
    }
    textarea { resize: vertical; min-height: 70px; line-height: 1.4; white-space: pre-wrap; }
    input:focus, textarea:focus { border-color: var(--primary); background: #475569; }

    /* LOCATION & BUTTONS */
    .location-wrapper { position: relative; }
    .suggestions-list {
      position: absolute; top: 100%; left: 0; right: 0;
      background: #1e293b; border: 1px solid #475569;
      border-radius: 0 0 8px 8px; z-index: 100;
      max-height: 200px; overflow-y: auto;
      display: none; box-shadow: 0 10px 15px rgba(0,0,0,0.5);
    }
    .gps-btn, .map-btn {
      background: rgba(16, 185, 129, 0.15); color: var(--success);
      border: 1px solid var(--success); padding: 8px;
      border-radius: 6px; font-size: 13px; cursor: pointer;
      font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 4px;
      width: 100%; transition: all 0.2s;
    }
    .gps-btn:hover, .map-btn:hover { background: var(--success); color: white; }

    /* TOGGLE SWITCH */
    .toggle-row {
        display: flex; justify-content: space-between; align-items: center;
        background: var(--bg-input); padding: 8px 12px; border-radius: var(--radius);
        margin-bottom: 5px;
    }
    .toggle-label { margin: 0; font-size: 0.85rem; color: white; text-transform: none; }
    .switch { position: relative; display: inline-block; width: 42px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider-toggle {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #64748b; transition: .4s; border-radius: 24px;
    }
    .slider-toggle:before {
      position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider-toggle { background-color: var(--primary); }
    input:checked + .slider-toggle:before { transform: translateX(18px); }

    /* RANGE SLIDERS */
    .slider-container { background: var(--bg-input); padding: 10px; border-radius: var(--radius); }
    .slider-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; color: #cbd5e1; }
    input[type=range] { width: 100%; height: 4px; background: #1e293b; border-radius: 2px; -webkit-appearance: none; cursor: pointer;}
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; border: 2px solid white; margin-top: -7px;
    }
    input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #475569; border-radius: 2px; }

    /* BUTTONS */
    .main-btn {
      padding: 14px; border: none; border-radius: var(--radius); font-weight: 600;
      cursor: pointer; font-size: 0.9rem; color: white; transition: 0.2s; width: 100%;
    }
    .btn-secondary { background: #334155; }
    .btn-primary { background: var(--primary); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    .btn-danger { background: var(--danger); }
    .file-btn {
      background: linear-gradient(45deg, #3b82f6, #6366f1);
      padding: 10px; border-radius: var(--radius); text-align: center; cursor: pointer; font-weight: 600;
      display: block; width: 100%; font-size: 14px;
    }

    @media (max-width: 768px) {
      main { flex-direction: column; }
      .canvas-wrap { order: 1; height: 40vh; width: 100%; border-bottom: 1px solid #334155; }
      .controls { 
        order: 2; height: 60vh; width: 100%; border-right: none; 
        border-top: 1px solid #334155; border-radius: 20px 20px 0 0;
        padding-bottom: 80px; 
      }
    }

    /* KAMERA & MODAL */
    .input-group-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .camera-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; z-index: 9999;
      display: none; flex-direction: column;
    }
    .btn-camera {
      background: linear-gradient(45deg, #059669, #10b981);
      color: white; font-weight: 600; border-radius: var(--radius);
      border: none; cursor: pointer; display: flex; align-items: center; 
      justify-content: center; gap: 6px; padding: 10px;
    }

    /* PETA */
    #mapView { flex-grow: 1; width: 100%; height: 100%; }
    .map-controls {
      position: absolute; bottom: 30px; left: 0; width: 100%;
      display: flex; justify-content: center; gap: 20px;
      padding: 0 20px; z-index: 1000; pointer-events: none;
    }
    .map-controls button { pointer-events: auto; }
    .cam-action-btn {
      background: rgba(0,0,0,0.6); border: 2px solid white; color: white;
      border-radius: 50%; cursor: pointer; font-size: 1.2rem; 
      width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
    }
    .cam-action-btn:hover { background: var(--primary); border-color: var(--primary); }

    /* Color Input */
    input[type="color"] {
        -webkit-appearance: none; border: none; width: 100%; height: 40px; border-radius: 8px; padding: 0; overflow: hidden;
    }
    input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type="color"]::-webkit-color-swatch { border: none; }
  </style>
</head>
<body>

  <header>Reko2stamp-SUPER (2.7)</header>

  <main>
    <aside class="controls">
      <div class="input-group-row">
        <label class="file-btn" style="margin:0; display:flex; align-items:center; justify-content:center; gap:5px;">
          üìÇ Galeri
          <input type="file" id="fileInput" accept="image/*" style="display: none;"/>
        </label>
        <button id="openCameraBtn" class="btn-camera">üì∑ Foto</button>
      </div>

      <div>
        <label>Waktu</label>
        <div class="toggle-row">
            <span class="toggle-label">Tampilkan Tanggal & Jam</span>
            <label class="switch">
                <input type="checkbox" id="showDateToggle" checked>
                <span class="slider-toggle"></span>
            </label>
        </div>
        <input type="datetime-local" id="dtInput"/>
      </div>

      <div>
        <label>Lokasi / Catatan</label>
        <div class="location-wrapper">
            <textarea id="locInput" rows="3" placeholder="Ketik lokasi atau klik tombol GPS..."></textarea>
            <div id="suggestions" class="suggestions-list"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
          <button id="gpsBtn" class="gps-btn" title="Gunakan Lokasi Saat Ini">
              üìç Cek GPS
          </button>
          <button id="mapBtn" class="map-btn" title="Pilih Lokasi di Peta">
              üó∫Ô∏è Cek Peta
          </button>
        </div>
      </div>

      <div>
        <label>Tampilan Stamp</label>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
           <select id="fontSelect">
              <option value="Roboto">Roboto (Default)</option>
              <option value="Montserrat">Montserrat</option>
              <option value="Oswald">Oswald</option>
              <option value="Great Vibes">Latin / Sambung</option>
              <option value="Share Tech Mono">Digital / Mono</option>
           </select>
           <input type="color" id="fontColor" value="#ffffff">
        </div>

        <div class="slider-container" style="margin-bottom: 10px;">
            <div class="slider-header">
                <span>Ukuran Text</span>
                <span id="sizeValDisplay">35px</span>
            </div>
            <input type="range" id="sizeSlider" min="10" max="100" value="35">
        </div>

        <div class="slider-container">
            <div class="slider-header">
                <span>Transparansi Text</span>
                <span id="opacityValDisplay">100%</span>
            </div>
            <input type="range" id="opacitySlider" min="20" max="100" value="100">
        </div>
      </div>

      <div class="input-group-row">
         <button id="resetViewBtn" class="main-btn btn-secondary">‚Ü∫ Reset View</button>
         <button id="clearBtn" class="main-btn btn-danger">üóë Hapus</button>
      </div>

      <button id="downloadFinal" class="main-btn btn-primary">‚¨á Simpan (JPEG)</button>
      <div style="font-size: 10px; color: #64748b; text-align: center; margin-top: 10px;">Created By AyaheDira</div>
    </aside>

    <section class="canvas-wrap" id="canvasContainer">
      <canvas id="canvas"></canvas>
    </section>
  </main>
  
  
  <div id="mapModal" class="camera-modal">
    <div id="mapView"></div>
    <div class="map-controls">
      <button id="closeMapBtn" class="cam-action-btn" title="Batal" style="background: #ef4444;">‚ùå</button>
      </div>
  </div>

  <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.85.1/dist/L.Control.Locate.min.js" charset="utf-8"></script>
  
  <script>
    // --- KONFIGURASI ---
    // DAFTAR GRATIS di https://locationiq.com/ untuk dapat API Key. 
    // Jika kosong, pencarian alamat (reverse geocode) mungkin terbatas/gagal.
    const LOCATIONIQ_KEY = 'pk.25381a16625807901016626639678853'; 

    // --- VARIABEL GLOBAL ---
    const fileInput = document.getElementById('fileInput');
    const openCameraBtn = document.getElementById('openCameraBtn');
    const cameraInput = document.getElementById('cameraInput'); // Native camera fallback
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const canvasContainer = document.getElementById('canvasContainer');

    // Controls
    const locInput = document.getElementById('locInput');
    const dtInput = document.getElementById('dtInput');
    const showDateToggle = document.getElementById('showDateToggle');
    const gpsBtn = document.getElementById('gpsBtn');
    const mapBtn = document.getElementById('mapBtn');
    
    // Style Controls
    const fontSelect = document.getElementById('fontSelect');
    const fontColor = document.getElementById('fontColor');
    const sizeSlider = document.getElementById('sizeSlider');
    const sizeValDisplay = document.getElementById('sizeValDisplay');
    const opacitySlider = document.getElementById('opacitySlider');
    const opacityValDisplay = document.getElementById('opacityValDisplay');
    
    // Actions
    const resetViewBtn = document.getElementById('resetViewBtn');
    const clearBtn = document.getElementById('clearBtn');
    const downloadFinalBtn = document.getElementById('downloadFinal');

    // State
    let sourceImage = null;
    let imgLoaded = false;
    let map = null;
    let marker = null;
    
    // Set Default Time
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    dtInput.value = now.toISOString().slice(0,16);

    // --- LOGIKA UTAMA (DRAW) ---
    function draw() {
        // 1. Reset Canvas / Background
        if (!imgLoaded || !sourceImage) {
            canvas.width = canvasContainer.clientWidth;
            canvas.height = canvasContainer.clientHeight;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#334155';
            ctx.font = '20px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Pilih File atau Foto untuk memulai', canvas.width/2, canvas.height/2);
            return;
        }

        // 2. Set Ukuran Canvas sesuai Gambar Asli
        canvas.width = sourceImage.width;
        canvas.height = sourceImage.height;

        // 3. Gambar Foto
        ctx.drawImage(sourceImage, 0, 0);

        // 4. Persiapan Stamp Text
        const fontSize = parseInt(sizeSlider.value) * (canvas.width / 1000) * 1.5; // Skala font responsif
        const lineHeight = fontSize * 1.2;
        const opacity = opacitySlider.value / 100;
        
        ctx.globalAlpha = opacity;
        ctx.fillStyle = fontColor.value;
        ctx.font = `bold ${fontSize}px '${fontSelect.value}', sans-serif`;
        ctx.shadowColor = "rgba(0,0,0,0.8)";
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        ctx.textAlign = "left";
        ctx.textBaseline = "bottom";

        // 5. Susun Teks (Lokasi + Waktu)
        let lines = [];
        
        // Lokasi (Multi-line support)
        if (locInput.value.trim() !== "") {
            const words = locInput.value.split('\n');
            words.forEach(line => lines.push(line));
        }

        // Tanggal (Jika diaktifkan)
        if (showDateToggle.checked && dtInput.value) {
            const d = new Date(dtInput.value);
            // Format Indonesia sederhana
            const dateStr = d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const timeStr = d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }).replace('.', ':');
            lines.push(`${dateStr}, ${timeStr} WIB`);
        }

        // 6. Render Teks ke Canvas (Posisi Bawah Kiri dengan Padding)
        const paddingX = canvas.width * 0.04;
        const paddingY = canvas.height * 0.04;
        let currentY = canvas.height - paddingY;

        // Render dari bawah ke atas
        for (let i = lines.length - 1; i >= 0; i--) {
            ctx.fillText(lines[i], paddingX, currentY);
            // Stroke (Outline) agar terbaca di background terang
            ctx.strokeStyle = 'black';
            ctx.lineWidth = fontSize / 15;
            ctx.strokeText(lines[i], paddingX, currentY);
            ctx.fillText(lines[i], paddingX, currentY);
            
            currentY -= lineHeight;
        }
        
        ctx.globalAlpha = 1.0; // Reset
    }

    // --- EVENT LISTENERS ---

    // Handle File Input
    fileInput.addEventListener('change', handleFileSelect);
    
    // Handle Camera Button (Mobile Native)
    openCameraBtn.addEventListener('click', () => {
        cameraInput.click();
    });
    cameraInput.addEventListener('change', handleFileSelect);

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            sourceImage = new Image();
            sourceImage.onload = () => {
                imgLoaded = true;
                draw();
                fitCanvasToScreen();
            };
            sourceImage.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    // Handle Input Changes (Realtime Update)
    [locInput, dtInput, showDateToggle, fontSelect, fontColor].forEach(el => {
        el.addEventListener('input', draw);
    });

    // Handle Sliders
    sizeSlider.addEventListener('input', () => {
        sizeValDisplay.textContent = sizeSlider.value + 'px';
        draw();
    });
    opacitySlider.addEventListener('input', () => {
        opacityValDisplay.textContent = opacitySlider.value + '%';
        draw();
    });

    // Tombol Aksi
    resetViewBtn.addEventListener('click', () => {
        // Reset slider ke default
        sizeSlider.value = 35;
        opacitySlider.value = 100;
        sizeValDisplay.textContent = '35px';
        opacityValDisplay.textContent = '100%';
        draw();
    });

    clearBtn.addEventListener('click', () => {
        if(confirm("Hapus foto dan mulai ulang?")) {
            sourceImage = null;
            imgLoaded = false;
            locInput.value = "";
            fileInput.value = "";
            draw();
        }
    });

    // CSS Transform agar Canvas pas di layar HP (Visual saja)
    function fitCanvasToScreen() {
        // Fungsi sederhana agar canvas tidak terlihat raksasa di layar HP
        // Ukuran asli canvas tetap resolusi penuh (untuk download)
        canvas.style.width = '100%';
        canvas.style.height = 'auto';
        canvas.style.objectFit = 'contain';
    }
    
    // GPS Otomatis (Browser API)
    gpsBtn.addEventListener('click', () => {
        gpsBtn.innerHTML = '‚è≥ Mencari...';
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                
                gpsBtn.innerHTML = 'üìç Cek GPS';
                
                // Coba ambil nama jalan (Reverse Geocoding)
                try {
                    const url = `https://us1.locationiq.com/v1/reverse.php?key=${LOCATIONIQ_KEY}&lat=${lat}&lon=${lng}&format=json`;
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if(data.display_name) {
                        // Ambil bagian alamat yang relevan saja (biar tidak kepanjangan)
                        let addr = data.address;
                        let text = `${addr.road || ''}, ${addr.suburb || ''}, ${addr.city || addr.county || ''}`;
                        locInput.value = text.replace(/^, /, '').replace(/, ,/g, ',');
                    } else {
                        locInput.value = `Lokasi: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                    }
                } catch(e) {
                    locInput.value = `GPS: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                }
                draw();
            }, (err) => {
                alert("Gagal ambil lokasi. Pastikan GPS aktif.");
                gpsBtn.innerHTML = 'üìç Cek GPS';
            });
        } else {
            alert("Browser tidak support GPS.");
        }
    });

    // --- SISTEM PETA (LEAFLET) ---
    const mapModal = document.getElementById('mapModal');
    const closeMapBtn = document.getElementById('closeMapBtn');

    async function initMap(lat = -2.5489, lng = 118.0149, zoom = 5) {
      if(map) return; // Jangan init ulang jika sudah ada

      map = L.map('mapView', {
        zoomSnap: 0.5,
        zoomDelta: 0.5,
        touchZoom: true
      }).setView([lat, lng], zoom);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 19
      }).addTo(map);

      // Fitur Search
      map.addControl(new L.Control.Search({
        position: 'topleft',
        url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}',
        jsonpParam: 'json_callback',
        propertyName: 'display_name',
        propertyLoc: ['lat','lon'],
        marker: false,
        autoCollapse: true,
        autoType: false,
        minLength: 2
      }));

      // Fitur Locate (GPS Button di Peta)
      L.control.locate({
        position: 'topright',
        strings: { title: "Posisi Saya" },
        locateOptions: { enableHighAccuracy: true }
      }).addTo(map);

      // Event Klik Peta
      map.on('click', async function(e) {
        if (marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);

        // Reverse Geo
        try {
           const url = `https://us1.locationiq.com/v1/reverse.php?key=${LOCATIONIQ_KEY}&lat=${e.latlng.lat}&lon=${e.latlng.lng}&format=json`;
           const r = await fetch(url);
           const d = await r.json();
           
           let simpleAddr = d.display_name ? d.display_name.split(',').slice(0,4).join(',') : `Lat: ${e.latlng.lat.toFixed(4)}`;
           locInput.value = simpleAddr;
        } catch(err) {
           locInput.value = `Pin: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
        }
        
        draw();
        // Tutup modal setelah pilih (delay sedikit biar user liat marker)
        setTimeout(() => mapModal.style.display = 'none', 400);
      });
    }

    mapBtn.addEventListener('click', () => {
      mapModal.style.display = 'flex';
      
      // Init peta jika belum, atau resize jika sudah
      if (!map) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => {
            initMap(pos.coords.latitude, pos.coords.longitude, 15);
          }, () => initMap());
        } else {
          initMap();
        }
      } else {
        setTimeout(() => map.invalidateSize(), 200); // Fix peta abu-abu
      }
    });

    closeMapBtn.addEventListener('click', () => {
      mapModal.style.display = 'none';
    });

    // --- DOWNLOAD ---
    downloadFinalBtn.addEventListener('click', () => {
        if(!imgLoaded) return alert("Belum ada foto!");
        
        const link = document.createElement('a');
        link.download = `Stamp_${Date.now()}.jpg`;
        // Kualitas 0.9 (90%)
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
    });

    // Render awal
    draw();

  </script>
</body>
</html>
