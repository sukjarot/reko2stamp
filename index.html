<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Reko2stamp-Ultimate (2.5)</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon ultimate.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Inter:wght@400;600&family=Montserrat:wght@500;700&family=Oswald:wght@500&family=Roboto:wght@400;500&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-app: #0f172a;       
      --bg-panel: #1e293b;     
      --bg-input: #334155;     
      --primary: #3b82f6;
      --danger: #ef4444;       
      --success: #10b981;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --radius: 12px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      margin: 0; font-family: 'Roboto', sans-serif; 
      background: var(--bg-app); color: var(--text-main); overflow: hidden; 
    }

    header { 
      height: 50px; /* Sedikit dipertinggi agar cahaya neon leluasa */
      background: var(--bg-panel); 
      border-bottom: 1px solid #334155;
      display: flex; align-items: center; justify-content: center;
      z-index: 50;
      
      /* --- EFEK NEON FUTURISTIK (VERSI SANS SERIF) --- */
      font-family: 'Montserrat', sans-serif; /* Menggunakan font sans-serif tebal */
      font-weight: 700; /* Wajib tebal (Bold) agar pendaran neon terlihat jelas */
      font-size: 24px;  /* Sedikit disesuaikan agar proporsional */
      color: #e0f2fe;   
      letter-spacing: 1.5px; /* Jarak antar huruf diperlebar agar terlihat mewah */
      text-transform: capitalize;
      
      /* Racikan Bayangan Neon Biru (Cyan) */
      text-shadow: 
          0 0 5px  rgba(6, 182, 212, 0.8),   /* Glow tajam dekat */
          0 0 10px rgba(6, 182, 212, 0.6),   /* Glow menyebar */
          0 0 20px rgba(59, 130, 246, 0.4),  /* Aura biru luar */
          0 0 40px rgba(59, 130, 246, 0.2);  /* Atmosfer redup */
    }

    main { display: flex; flex-direction: row; height: calc(100vh - 50px); }

    .canvas-wrap { 
      flex-grow: 1; position: relative; background: #000; 
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; touch-action: none;
      background-image: radial-gradient(#334155 1px, transparent 1px);
      background-size: 20px 20px; order: 2; 
    }
    canvas { box-shadow: 0 0 40px rgba(0,0,0,0.5); transform-origin: 0 0; }

    .controls { 
      width: 360px; background: var(--bg-panel); padding: 20px; 
      overflow-y: auto; border-right: 1px solid #334155;
      display: flex; flex-direction: column; gap: 16px;
      z-index: 40; order: 1;
    }

    label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; display: block; font-weight: 500; text-transform: uppercase; }

    input[type="text"], input[type="datetime-local"], select, textarea {
      width: 100%; padding: 12px; background: var(--bg-input); 
      border: 1px solid transparent; border-radius: var(--radius); 
      color: white; font-family: inherit; outline: none; font-size: 14px;
    }
    textarea { resize: vertical; min-height: 80px; line-height: 1.5; }
    input:focus, textarea:focus { border-color: var(--primary); background: #475569; }

    /* LOCATION AUTOCOMPLETE STYLE */
    .location-wrapper { position: relative; }
    .suggestions-list {
      position: absolute; top: 100%; left: 0; right: 0;
      background: #1e293b; border: 1px solid #475569;
      border-radius: 0 0 8px 8px; z-index: 100;
      max-height: 200px; overflow-y: auto;
      display: none; box-shadow: 0 10px 15px rgba(0,0,0,0.5);
    }
    .suggestion-item {
      padding: 10px; font-size: 13px; border-bottom: 1px solid #334155;
      cursor: pointer; color: #e2e8f0;
    }
    .suggestion-item:hover { background: var(--primary); color: white; }
    .gps-btn {
      position: absolute; right: 8px; top: 8px;
      background: rgba(16, 185, 129, 0.2); color: var(--success);
      border: 1px solid var(--success); padding: 4px 8px;
      border-radius: 6px; font-size: 11px; cursor: pointer;
      font-weight: bold; display: flex; align-items: center; gap: 4px;
    }
    .gps-btn:hover { background: var(--success); color: white; }

    /* TOGGLE SWITCH */
    .toggle-row {
        display: flex; justify-content: space-between; align-items: center;
        background: var(--bg-input); padding: 8px 12px; border-radius: var(--radius);
        margin-bottom: 8px;
    }
    .toggle-label { margin: 0; font-size: 0.85rem; color: white; text-transform: none; }
    .switch { position: relative; display: inline-block; width: 42px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #64748b; transition: .4s; border-radius: 24px;
    }
    .slider:before {
      position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(18px); }

    /* SLIDERS */
    .slider-container { background: var(--bg-input); padding: 10px; border-radius: var(--radius); }
    .slider-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
    .slider-group { display: flex; align-items: center; gap: 8px; }
    .btn-adjust {
      width: 30px; height: 30px; background: #475569; border: none; border-radius: 50%;
      color: white; cursor: pointer; display: grid; place-items: center; font-weight: bold;
    }
    input[type=range] { flex-grow: 1; height: 4px; background: #1e293b; border-radius: 2px; -webkit-appearance: none; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; border: 2px solid white; cursor: pointer;
    }

    /* BUTTONS */
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button.main-btn {
      padding: 14px; border: none; border-radius: var(--radius); font-weight: 600;
      cursor: pointer; font-size: 0.9rem; color: white; transition: 0.2s;
    }
    button.main-btn:active { transform: scale(0.96); }
    .btn-secondary { background: #334155; }
    .btn-primary { background: var(--primary); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    .btn-danger { background: var(--danger); }
    .file-btn {
      background: linear-gradient(45deg, #3b82f6, #6366f1);
      padding: 12px; border-radius: var(--radius); text-align: center; cursor: pointer; font-weight: 600;
      display: block; width: 100%;
    }

    @media (max-width: 768px) {
      main { flex-direction: column; }
      .canvas-wrap { order: 1; height: 45vh; width: 100%; border-bottom: 1px solid #334155; }
      .controls { 
        order: 2; height: 55vh; width: 100%; border-right: none; 
        border-top: 1px solid #334155; border-radius: 20px 20px 0 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.4); padding-bottom: 80px; 
      }
    }

    /* CSS KAMERA */
    .input-group-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;
    }
    .camera-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; z-index: 9999;
      display: none; flex-direction: column;
    }
    .camera-view {
      flex-grow: 1; width: 100%; height: 100%; object-fit: cover;
      background: #000; transition: transform 0.3s ease;
    }
    .camera-controls {
      position: absolute; bottom: 30px; left: 0; width: 100%;
      display: flex; justify-content: space-around; align-items: center;
      padding: 0 20px;
    }
    .shutter-btn {
      width: 70px; height: 70px; border-radius: 50%;
      background: white; border: 4px solid rgba(255,255,255,0.3);
      cursor: pointer; transition: 0.2s;
    }
    .shutter-btn:active { transform: scale(0.9); background: #eee; }
    .cam-action-btn {
      background: rgba(255,255,255,0.2); border: none; color: white;
      padding: 12px; border-radius: 50%; cursor: pointer;
      font-size: 1.2rem; width: 50px; height: 50px;
      display: flex; align-items: center; justify-content: center;
    }
    .cam-action-btn:hover { background: rgba(255,255,255,0.4); }
    .btn-camera {
      background: linear-gradient(45deg, #059669, #10b981);
      color: white; font-weight: 600; border-radius: var(--radius);
      border: none; cursor: pointer; display: flex; align-items: center; 
      justify-content: center; gap: 6px;
    }
  </style>
</head>
<body>

  <header>Reko2stamp-Ultimate (2.5)</header>

  <main>
    <aside class="controls">
      <div class="input-group-row">
        <label class="file-btn" style="margin:0; display:flex; align-items:center; justify-content:center; gap:5px;">
          üìÇ Galeri
          <input type="file" id="fileInput" accept="image/*" style="display: none;"/>
        </label>
        <button id="openCameraBtn" class="btn-camera">üì∑ Foto</button>
      </div>

      <div>
        <label>Pengaturan Waktu</label>
        <div class="toggle-row">
            <span class="toggle-label">Tampilkan Tanggal & Jam</span>
            <label class="switch">
                <input type="checkbox" id="showDateToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
        <input type="datetime-local" id="dtInput"/>
      </div>

      <div>
        <label>Lokasi / Catatan</label>
        <div class="location-wrapper">
            <textarea id="locInput" rows="3" placeholder="Ketik lokasi atau klik tombol GPS..."></textarea>
            
            <button id="gpsBtn" class="gps-btn" title="Gunakan Lokasi Saat Ini">
                üìç Cek GPS
            </button>

            <div id="suggestions" class="suggestions-list"></div>
        </div>
        <div style="font-size: 10px; color: #64748b; margin-top: 4px;">*By AyaheDira</div>
      </div>

      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
        <div>
          <label>Font</label>
          <select id="fontSelect">
            <option value="Roboto">Roboto</option>
            <option value="Montserrat">Montserrat</option>
            <option value="Oswald">Oswald Bold</option>
            <option value="Share Tech Mono">Digital</option>
            <option value="Great Vibes">Signature</option>
          </select>
        </div>
        <div>
           <label>Warna</label>
           <input type="color" id="fontColor" value="#ffffff" style="height: 44px; padding: 2px;">
        </div>
      </div>

      <div>
        <label>Ukuran Teks</label>
        <div class="slider-container">
            <div class="slider-header"><span>Size</span><span id="sizeVal">80px</span></div>
            <div class="slider-group">
                <button class="btn-adjust" onclick="adjustSize(-5)">-</button>
                <input type="range" id="sizeSlider" min="20" max="300" value="80" step="5">
                <button class="btn-adjust" onclick="adjustSize(5)">+</button>
            </div>
        </div>
      </div>

      <div>
        <label>Transparansi</label>
        <div class="slider-container">
            <div class="slider-header"><span>Opacity</span><span id="opacityVal">90%</span></div>
            <div class="slider-group">
                <input type="range" id="opacitySlider" min="0" max="100" step="5" value="90">
            </div>
        </div>
      </div>

      <div class="action-grid" style="grid-template-columns: 1fr 1fr 1fr;">
        <button id="resetView" class="main-btn btn-secondary" style="padding: 10px; font-size: 0.8rem;">‚Ü∫ Reset</button>
        <button id="rotateBtn" class="main-btn btn-secondary" style="padding: 10px; font-size: 0.8rem;">‚§µ Putar</button>
        <button id="toggleCrop" class="main-btn btn-secondary" style="padding: 10px; font-size: 0.8rem;">‚úÇ Potong</button>
      </div>

      <button id="clearBtn" class="main-btn btn-danger" style="margin-top: 10px; margin-bottom: 10px;">üóë Hapus Foto</button>

      <button id="downloadFinal" class="main-btn btn-primary">‚¨á Simpan (Max 4MB)</button>
    </aside>

    <section class="canvas-wrap" id="canvasContainer">
      <canvas id="canvas"></canvas>
    </section>
  </main>
  
  <div id="cameraModal" class="camera-modal">
    <video id="cameraVideo" class="camera-view" autoplay playsinline></video>
    
    <div class="camera-controls">
      <button id="closeCamBtn" class="cam-action-btn" title="Tutup">‚ùå</button>
      <button id="rotateCamBtn" class="cam-action-btn" title="Putar Kamera">‚§µÔ∏è</button>
      <button id="shutterBtn" class="shutter-btn" title="Ambil Foto"></button>
      <button id="switchCamBtn" class="cam-action-btn" title="Ganti Kamera">üîÑ</button>
    </div>
  </div>
  <script>
    // --- PENDAFTARAN SERVICE WORKER (PWA) ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker terdaftar!', reg.scope))
                .catch(err => console.log('Gagal daftar Service Worker:', err));
        });
    }
    
    // --- 1. INISIALISASI VARIABEL GLOBAL ---
    // --- MASUKKAN TOKEN DARI LOCATIONIQ DI SINI ---
    const LOCATIONIQ_KEY = 'pk.9415d0e1f42e8b4c9b6d9be7be2f5108';
    const fileInput = document.getElementById('fileInput');
    const dtInput = document.getElementById('dtInput');
    const showDateToggle = document.getElementById('showDateToggle');
    const locInput = document.getElementById('locInput');
    const gpsBtn = document.getElementById('gpsBtn');
    const suggestionsBox = document.getElementById('suggestions');

    const sizeSlider = document.getElementById('sizeSlider');
    const sizeValDisplay = document.getElementById('sizeVal');
    const opacitySlider = document.getElementById('opacitySlider');
    const opacityValDisplay = document.getElementById('opacityVal');
    const fontColor = document.getElementById('fontColor');
    const fontSelect = document.getElementById('fontSelect');
    
    const resetViewBtn = document.getElementById('resetView');
    const toggleCropBtn = document.getElementById('toggleCrop');
    const clearBtn = document.getElementById('clearBtn');
    const rotateBtn = document.getElementById('rotateBtn');
    const downloadFinalBtn = document.getElementById('downloadFinal');
    const canvasContainer = document.getElementById('canvasContainer');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // SISTEM BARU
    let sourceImage = null; 
    let isUsingCanvasSource = false; 
    let imgLoaded = false;
    let isNewFile = false;

    // States Touch/UI
    let viewScale = 1; let viewX = 0; let viewY = 0;
    
    // Stamp State
    let stampX = 50, stampY = 100;
    let draggingStamp = false; 
    
    // Crop State
    let cropMode = false; 
    let cropRect = null; 
    let cropAction = null; 
    let dragStartPos = {x:0, y:0};
    let initialCropRect = null; 

    // Pinch Zoom State
    let initialPinchDist = 0; let initialScale = 1; let lastPanX = 0; let lastPanY = 0;
    let isDrawing = false; 

    const MAX_DIMENSION = 4096;
    const MAX_FILE_SIZE = 4 * 1024 * 1024;
    
    // --- SETTING UKURAN HANDLE (UPDATED FOR MOBILE) ---
    const VISUAL_HANDLE_SIZE = 30; // Ukuran kotak biru yang terlihat (px)
    const TOUCH_HANDLE_SIZE = 80;  // Area sentuh invisible (Sangat besar agar mudah kena jempol)

    // Init Date
    const now = new Date();
    const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    dtInput.value = localIso;

    // --- Pendaftaran Service Worker (Agar Offline Jalan) ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Gagal', err));
        });
    }

    // --- 2. HELPER RENDERING ---
    function requestRender() {
        if (!isDrawing) {
            isDrawing = true;
            requestAnimationFrame(() => {
                draw();
                isDrawing = false;
            });
        }
    }

    function getSourceWidth() {
        if (!sourceImage) return 0;
        return isUsingCanvasSource ? sourceImage.width : sourceImage.naturalWidth;
    }

    function getSourceHeight() {
        if (!sourceImage) return 0;
        return isUsingCanvasSource ? sourceImage.height : sourceImage.naturalHeight;
    }

    // --- 3. LOGIKA UTAMA (DRAW & CANVAS) ---
    function updateTransform() { 
        canvas.style.transform = `translate(${viewX}px, ${viewY}px) scale(${viewScale})`; 
    }

    function draw() {
        if (!imgLoaded || !sourceImage) { 
            canvas.width = 300; canvas.height = 300;
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,300,300);
            ctx.fillStyle = '#64748b'; ctx.font = '16px Roboto'; ctx.textAlign = 'center';
            ctx.fillText('Pilih Foto Dulu', 150, 150);
            return; 
        }
        
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);

        // Render Text / Stamp
        const text = buildStampText();
        const fSize = parseInt(sizeSlider.value);
        const alpha = parseInt(opacitySlider.value) / 100;
        
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.font = `bold ${fSize}px "${fontSelect.value}"`; 
        ctx.fillStyle = fontColor.value || '#fff';
        ctx.textAlign = 'left';
        
        const shadowSize = Math.max(2, fSize / 15);
        ctx.shadowColor = `rgba(0,0,0,${alpha})`;
        ctx.shadowBlur = shadowSize; ctx.shadowOffsetX = shadowSize/2; ctx.shadowOffsetY = shadowSize/2;

        wrapText(text, stampX, stampY, canvas.width - (stampX + 20), fSize * 1.25);
        ctx.restore();

        // --- RENDER CROP UI ---
        if (cropMode && cropRect) {
            ctx.save();
            
            // Dimming Area Luar
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.rect(cropRect.x, cropRect.y, cropRect.w, cropRect.h); 
            ctx.clip("evenodd"); 
            ctx.fill();

            // Garis Batas
            ctx.strokeStyle = 'rgba(0,0,0,0.5)'; ctx.lineWidth = 4 / viewScale; ctx.setLineDash([]);
            ctx.strokeRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);
            ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 2 / viewScale; ctx.setLineDash([12, 6]);
            ctx.strokeRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);

            // HANDLES (Visual Box)
            ctx.setLineDash([]);
            // Kita pakai VISUAL_HANDLE_SIZE di sini agar tampilan tetap rapi (tidak terlalu besar)
            const vHandle = VISUAL_HANDLE_SIZE / viewScale; 
            const halfH = vHandle / 2;
            
            ctx.fillStyle = '#3b82f6'; ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 2 / viewScale;

            const drawH = (cx, cy) => {
                ctx.beginPath();
                ctx.rect(cx - halfH, cy - halfH, vHandle, vHandle);
                ctx.fill(); ctx.stroke();
            };

            const l = cropRect.x; const cX = cropRect.x + cropRect.w / 2; const r = cropRect.x + cropRect.w;
            const t = cropRect.y; const cY = cropRect.y + cropRect.h / 2; const b = cropRect.y + cropRect.h;

            drawH(l, t); drawH(cX, t); drawH(r, t);
            drawH(r, cY); drawH(r, b); drawH(cX, b);
            drawH(l, b); drawH(l, cY);

            // Grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; ctx.lineWidth = 1 / viewScale; ctx.beginPath();
            ctx.moveTo(cropRect.x + cropRect.w/3, cropRect.y); ctx.lineTo(cropRect.x + cropRect.w/3, cropRect.y + cropRect.h);
            ctx.moveTo(cropRect.x + 2*cropRect.w/3, cropRect.y); ctx.lineTo(cropRect.x + 2*cropRect.w/3, cropRect.y + cropRect.h);
            ctx.moveTo(cropRect.x, cropRect.y + cropRect.h/3); ctx.lineTo(cropRect.x + cropRect.w, cropRect.y + cropRect.h/3);
            ctx.moveTo(cropRect.x, cropRect.y + 2*cropRect.h/3); ctx.lineTo(cropRect.x + cropRect.w, cropRect.y + 2*cropRect.h/3);
            ctx.stroke();

            ctx.restore();
        }
    }

    function buildStampText() {
        let text = '';
        if (showDateToggle.checked) {
            const dt = new Date(dtInput.value);
            if(!isNaN(dt)) {
                const pad = n => n.toString().padStart(2, '0');
                text += `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
            }
        }
        const loc = locInput.value.trim();
        if (loc) { if (text) text += '\n'; text += loc; }
        return text;
    }

    function wrapText(text, x, y, maxWidth, lineHeight) {
        const lines = text.split('\n');
        for (let i = 0; i < lines.length; i++) { ctx.fillText(lines[i], x, y + (i * lineHeight)); }
    }

    function setupHighResCanvas() {
        if (!sourceImage) return;
        let w = getSourceWidth();
        let h = getSourceHeight();
        if (w > MAX_DIMENSION || h > MAX_DIMENSION) {
            const ratio = w / h;
            if (w > h) { w = MAX_DIMENSION; h = Math.round(w / ratio); } 
            else { h = MAX_DIMENSION; w = Math.round(h * ratio); }
        }
        canvas.width = w; canvas.height = h;

        const padding = 20; 
        const isMobile = window.innerWidth < 768;
        const screenW = isMobile ? (window.innerWidth - padding) : (window.innerWidth - 380);
        const screenH = isMobile ? (window.innerHeight * 0.40) : (window.innerHeight - 80);
        const ratio = w / h;
        let cssW = screenW; let cssH = cssW / ratio;
        if (cssH > screenH) { cssH = screenH; cssW = cssH * ratio; }
        canvas.style.width = `${cssW}px`; canvas.style.height = `${cssH}px`;
        
        if(isNewFile) { 
            viewScale = 1; viewX = 0; viewY = 0; updateTransform(); 
            stampX = canvas.width * 0.05; 
            stampY = canvas.height - (canvas.height * 0.1); 
            const autoSize = Math.max(40, Math.round(canvas.width * 0.04));
            sizeSlider.value = autoSize; 
            sizeValDisplay.textContent = autoSize + 'px';
            isNewFile = false;
        }
        draw();
    }

    // --- 4. INTERAKSI TOUCH (UPDATED HIT REGION) ---
    
    function getHitRegion(x, y) {
        if (!cropRect) return null;
        
        // PENGATURAN TOLERANSI SENTUH (SANGAT PENTING UNTUK HP)
        // Kita pakai TOUCH_HANDLE_SIZE agar area deteksinya luas
        const hitSize = (TOUCH_HANDLE_SIZE / viewScale); 
        const halfHit = hitSize / 2;
        
        const l = cropRect.x;
        const cX = cropRect.x + cropRect.w / 2;
        const r = cropRect.x + cropRect.w;
        const t = cropRect.y;
        const cY = cropRect.y + cropRect.h / 2;
        const b = cropRect.y + cropRect.h;

        // Cek apakah koordinat (x,y) masuk dalam kotak imajiner handle
        const check = (tx, ty) => {
            return (x >= tx - halfHit && x <= tx + halfHit && y >= ty - halfHit && y <= ty + halfHit);
        };

        if (check(l, t)) return 'nw';
        if (check(cX, t)) return 'n';
        if (check(r, t)) return 'ne';
        
        if (check(r, cY)) return 'e';
        if (check(r, b)) return 'se';
        
        if (check(cX, b)) return 's';
        if (check(l, b)) return 'sw';
        if (check(l, cY)) return 'w';

        // Cek Move (Badan)
        if (x > l && x < r && y > t && y < b) return 'move';

        return null;
    }

    function getDist(touches) { return Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY); }
    function getPos(clientX, clientY) {
        const rect = canvas.getBoundingClientRect(); 
        const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height;
        return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
    }

    function handleStart(clientX, clientY) {
        const pos = getPos(clientX, clientY);
        dragStartPos = pos;

        if (cropMode) {
            const hit = getHitRegion(pos.x, pos.y);
            if (hit) {
                cropAction = hit;
                initialCropRect = { ...cropRect };
            } else {
                cropAction = 'create';
                cropRect = { x: pos.x, y: pos.y, w: 0, h: 0 };
            }
        } else {
            const fSize = parseInt(sizeSlider.value);
            if (pos.x >= stampX - fSize && pos.x <= stampX + (fSize*10) && pos.y >= stampY - fSize && pos.y <= stampY + (fSize*2)) {
                draggingStamp = true;
            }
        }
    }

    function handleMove(clientX, clientY) {
        const pos = getPos(clientX, clientY);

        if (cropMode && cropAction) {
            if (cropAction === 'create') {
                cropRect.w = pos.x - dragStartPos.x;
                cropRect.h = pos.y - dragStartPos.y;
            } 
            else if (cropAction === 'move') {
                const dx = pos.x - dragStartPos.x;
                const dy = pos.y - dragStartPos.y;
                cropRect.x = initialCropRect.x + dx;
                cropRect.y = initialCropRect.y + dy;
            } 
            else {
                const dx = pos.x - dragStartPos.x;
                const dy = pos.y - dragStartPos.y;
                const i = initialCropRect;

                if (cropAction.includes('n')) { cropRect.y = i.y + dy; cropRect.h = i.h - dy; }
                if (cropAction.includes('s')) { cropRect.h = i.h + dy; }
                if (cropAction.includes('w')) { cropRect.x = i.x + dx; cropRect.w = i.w - dx; }
                if (cropAction.includes('e')) { cropRect.w = i.w + dx; }
            }
            requestRender();
        } 
        else if (draggingStamp) {
             stampX = pos.x; stampY = pos.y; 
            requestRender();
        }
    }

    function handleEnd() {
        if (cropMode && cropRect) {
            if (cropRect.w < 0) { cropRect.x += cropRect.w; cropRect.w = Math.abs(cropRect.w); }
            if (cropRect.h < 0) { cropRect.y += cropRect.h; cropRect.h = Math.abs(cropRect.h); }
        }
        cropAction = null; draggingStamp = false; initialCropRect = null;
    }

    // --- EVENT LISTENERS ---
    canvasContainer.addEventListener('touchstart', (e) => {
        if(!imgLoaded) return;
        if (e.touches.length === 2) {
            e.preventDefault();
            initialPinchDist = getDist(e.touches); initialScale = viewScale;
            lastPanX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            lastPanY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
        } else if (e.touches.length === 1) {
            handleStart(e.touches[0].clientX, e.touches[0].clientY);
        }
    }, {passive: false});

    canvasContainer.addEventListener('touchmove', (e) => {
        if(!imgLoaded) return;
        e.preventDefault(); 
        if (e.touches.length === 2) {
            const currentDist = getDist(e.touches);
            const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            const newScale = initialScale * (currentDist / initialPinchDist);
            viewScale = Math.min(Math.max(0.1, newScale), 10); 
            const dx = centerX - lastPanX; const dy = centerY - lastPanY;
            viewX += dx; viewY += dy; lastPanX = centerX; lastPanY = centerY; updateTransform();
        } else if (e.touches.length === 1) {
            handleMove(e.touches[0].clientX, e.touches[0].clientY);
        }
    }, {passive: false});

    canvasContainer.addEventListener('touchend', handleEnd);

    // MOUSE
    canvasContainer.addEventListener('mousedown', (e) => { if(!imgLoaded) return; handleStart(e.clientX, e.clientY); });
    window.addEventListener('mousemove', (e) => { if(!imgLoaded) return; if (e.buttons === 1) handleMove(e.clientX, e.clientY); });
    window.addEventListener('mouseup', handleEnd);


    // --- 5. INPUT FILE & LAINNYA ---
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        isNewFile = true; const reader = new FileReader();
        reader.onload = (ev) => {
            const tempImg = new Image();
            tempImg.onload = () => { sourceImage = tempImg; isUsingCanvasSource = false; imgLoaded = true; setupHighResCanvas(); };
            tempImg.src = ev.target.result;
        }; reader.readAsDataURL(file);
    });

    // KAMERA
    const openCameraBtn = document.getElementById('openCameraBtn');
    const cameraModal = document.getElementById('cameraModal');
    const cameraVideo = document.getElementById('cameraVideo');
    const closeCamBtn = document.getElementById('closeCamBtn');
    const shutterBtn = document.getElementById('shutterBtn');
    const switchCamBtn = document.getElementById('switchCamBtn');
    const rotateCamBtn = document.getElementById('rotateCamBtn');
    let currentStream = null; let facingMode = 'environment'; let currentRotation = 0; 

    openCameraBtn.addEventListener('click', async () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert("Browser error."); return; }
        await startCamera();
    });
    async function startCamera() {
        if (currentStream) stopCamera(); updateVideoStyle();
        try {
            currentStream = await navigator.mediaDevices.getUserMedia({video: { facingMode: facingMode, width: {ideal:4096}, height: {ideal:2160} }});
            cameraVideo.srcObject = currentStream; cameraModal.style.display = 'flex';
        } catch (err) { alert("Gagal akses kamera."); cameraModal.style.display = 'none'; }
    }
    function stopCamera() { if (currentStream) { currentStream.getTracks().forEach(t => t.stop()); currentStream = null; } cameraVideo.srcObject = null; }
    closeCamBtn.addEventListener('click', () => { stopCamera(); cameraModal.style.display = 'none'; });
    switchCamBtn.addEventListener('click', () => { facingMode = (facingMode==='environment')?'user':'environment'; startCamera(); });
    rotateCamBtn.addEventListener('click', () => { currentRotation = (currentRotation+90)%360; updateVideoStyle(); });
    function updateVideoStyle() {
        let t = `rotate(${currentRotation}deg)`; if(facingMode==='user') t+=` scaleX(-1)`;
        cameraVideo.style.transform = t; cameraVideo.style.objectFit=(currentRotation%180!==0)?"contain":"cover";
    }
    shutterBtn.addEventListener('click', () => {
        if(!currentStream) return;
        const vW = cameraVideo.videoWidth; const vH = cameraVideo.videoHeight;
        const tC = document.createElement('canvas'); const ctxT = tC.getContext('2d');
        if(currentRotation%180!==0) { tC.width=vH; tC.height=vW; } else { tC.width=vW; tC.height=vH; }
        ctxT.translate(tC.width/2, tC.height/2); ctxT.rotate(currentRotation*Math.PI/180);
        if(facingMode==='user') ctxT.scale(-1,1);
        ctxT.drawImage(cameraVideo, -vW/2, -vH/2, vW, vH);
        sourceImage = tC; isUsingCanvasSource=true; imgLoaded=true; isNewFile=true;
        stopCamera(); cameraModal.style.display='none'; setupHighResCanvas();
        const n = new Date(); dtInput.value=new Date(n-n.getTimezoneOffset()*60000).toISOString().slice(0,16);
    });

    // ROTATE
    rotateBtn.addEventListener('click', () => {
        if(!imgLoaded || !sourceImage) return;
        const origT = rotateBtn.textContent; rotateBtn.textContent = '‚è≥'; 
        requestAnimationFrame(() => {
            const w = getSourceWidth(); const h = getSourceHeight();
            const tC = document.createElement('canvas'); tC.width = h; tC.height = w;
            const xT = tC.getContext('2d');
            xT.translate(tC.width/2, tC.height/2); xT.rotate(90*Math.PI/180);
            xT.drawImage(sourceImage, -w/2, -h/2);
            sourceImage = tC; isUsingCanvasSource = true;
            setupHighResCanvas();
            if(cropMode) { cropRect = null; cropAction=null; toggleCropBtn.textContent='‚úÇ Potong'; toggleCropBtn.classList.remove('btn-danger'); toggleCropBtn.classList.add('btn-secondary'); cropMode=false; }
            draw(); rotateBtn.textContent = origT;
        });
    });

    // CROP BUTTON
    toggleCropBtn.addEventListener('click', () => {
        if (cropMode) {
            if (cropRect && cropRect.w > 10 && cropRect.h > 10) applyCrop();
            cropMode = false;
            toggleCropBtn.textContent = '‚úÇ Potong';
            toggleCropBtn.classList.remove('btn-danger'); toggleCropBtn.classList.add('btn-secondary');
        } else {
            cropMode = true; 
            const cw = canvas.width; const ch = canvas.height;
            cropRect = { x: cw*0.1, y: ch*0.1, w: cw*0.8, h: ch*0.8 };
            toggleCropBtn.textContent = '‚úÖ Terapkan';
            toggleCropBtn.classList.remove('btn-secondary'); toggleCropBtn.classList.add('btn-danger');
        }
        draw();
    });

    function applyCrop() {
        if (!sourceImage || !cropRect) return;
        const x = cropRect.w < 0 ? cropRect.x + cropRect.w : cropRect.x;
        const y = cropRect.h < 0 ? cropRect.y + cropRect.h : cropRect.y;
        const w = Math.abs(cropRect.w);
        const h = Math.abs(cropRect.h);
        const tC = document.createElement('canvas'); tC.width = w; tC.height = h;
        const tX = tC.getContext('2d');
        tX.drawImage(sourceImage, x, y, w, h, 0, 0, w, h);
        sourceImage = tC; isUsingCanvasSource = true; setupHighResCanvas();
    }

    // GPS Location
    // --- KODE BARU: TOMBOL GPS DENGAN LOCATIONIQ ---
    gpsBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
            alert("Browser tidak mendukung GPS.");
            return;
        }
        gpsBtn.innerHTML = "‚è≥ Mengambil...";
        
        navigator.geolocation.getCurrentPosition(async (p) => {
            try {
                // Menggunakan LocationIQ
                const url = `https://us1.locationiq.com/v1/reverse.php?key=${LOCATIONIQ_KEY}&lat=${p.coords.latitude}&lon=${p.coords.longitude}&format=json`;
                
                const r = await fetch(url);
                const d = await r.json();

                if (d.error) throw new Error(d.error);

                // --- LOGIKA PERAPIH ALAMAT ---
                // LocationIQ memberikan 'display_name' yang sangat panjang.
                // Kita ambil 3-4 bagian depannya saja agar pas di foto.
                let addressParts = d.display_name.split(',');
                
                // Ambil maksimal 3 komponen pertama (misal: Nama Gedung, Jalan, Kecamatan)
                let simpleAddress = addressParts.slice(0, 3).join(',').trim();
                
                // Masukkan ke kotak input
                locInput.value = `${simpleAddress}\n(${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)})`;
                
                // Update canvas
                draw();
                gpsBtn.innerHTML = "üìç Cek GPS";

            } catch(e) {
                console.error(e);
                alert("Gagal mendeteksi lokasi: " + e.message);
                gpsBtn.innerHTML = "üìç Cek GPS";
            }
        }, (err) => {
            console.warn(err);
            alert("Aktifkan GPS di HP kamu!");
            gpsBtn.innerHTML = "üìç Cek GPS";
        }, {
            enableHighAccuracy: true, // Pakai mode akurasi tinggi
            timeout: 10000,
            maximumAge: 0
        });
    });

    let debT;
    locInput.addEventListener('input', (e) => {
        requestRender(); // Update tampilan teks di foto real-time
        
        const query = e.target.value.split('\n')[0]; // Ambil baris pertama saja untuk pencarian
        if(query.length < 3) return; // Jangan cari kalau baru ngetik 1-2 huruf

        clearTimeout(debT);
        debT = setTimeout(async() => {
            try {
                // Menggunakan API Search LocationIQ
                const url = `https://us1.locationiq.com/v1/search.php?key=${LOCATIONIQ_KEY}&q=${encodeURIComponent(query)}&format=json&limit=5`;
                
                const r = await fetch(url);
                const res = await r.json();
                
                suggestionsBox.innerHTML = '';
                
                if (Array.isArray(res) && res.length > 0) {
                    suggestionsBox.style.display = 'block';
                    res.forEach(p => {
                        const d = document.createElement('div');
                        d.className = 'suggestion-item';
                        // Tampilkan nama tempat + sedikit detail di bawahnya
                        d.textContent = p.display_name; 
                        
                        d.onclick = () => {
                            // Saat dipilih, ambil nama tempatnya saja
                            // Biar tidak kepanjangan, kita ambil 3 bagian pertama
                            let simpleName = p.display_name.split(',').slice(0, 3).join(',');
                            
                            locInput.value = `${simpleName}\n(${parseFloat(p.lat).toFixed(5)}, ${parseFloat(p.lon).toFixed(5)})`;
                            suggestionsBox.style.display = 'none';
                            requestRender();
                        };
                        suggestionsBox.appendChild(d);
                    });
                } else {
                    suggestionsBox.style.display = 'none';
                }
            } catch(err) {
                // Silent error (tidak perlu alert kalau gagal search)
            }
        }, 800); // Delay sedikit lebih lama (800ms) agar hemat request API
    });
    document.addEventListener('click', e => { if(!e.target.closest('.location-wrapper')) suggestionsBox.style.display='none'; });

    window.adjustSize = (n) => { sizeSlider.value=parseInt(sizeSlider.value)+n; sizeValDisplay.textContent=sizeSlider.value+'px'; requestRender(); };
    sizeSlider.addEventListener('input', ()=>{ sizeValDisplay.textContent=sizeSlider.value+'px'; requestRender(); });
    opacitySlider.addEventListener('input', ()=>{ opacityValDisplay.textContent=opacitySlider.value+'%'; requestRender(); });
    [dtInput, fontColor, fontSelect, showDateToggle].forEach(e=>e.addEventListener('input', requestRender));
    window.addEventListener('resize', ()=>{if(sourceImage) setupHighResCanvas();});
    
    resetViewBtn.addEventListener('click', ()=>{ if(imgLoaded){ viewScale=1; viewX=0; viewY=0; updateTransform(); stampX=canvas.width*0.05; stampY=canvas.height*0.9; draw(); } });
    clearBtn.addEventListener('click', ()=>{ if(imgLoaded && confirm('Hapus?')) { sourceImage=null; imgLoaded=false; isNewFile=false; fileInput.value=''; cropMode=false; toggleCropBtn.textContent='‚úÇ Potong'; toggleCropBtn.classList.remove('btn-danger'); toggleCropBtn.classList.add('btn-secondary'); draw(); } });

    downloadFinalBtn.addEventListener('click', () => {
        if(!imgLoaded) return;
        draw();
        const oT = downloadFinalBtn.textContent; downloadFinalBtn.textContent = '‚è≥...'; downloadFinalBtn.disabled = true;
        (function c(q) {
            canvas.toBlob(b => {
                if(b.size>MAX_FILE_SIZE && q>0.1) c(q-0.05);
                else {
                    const l = document.createElement('a'); l.download=`Stamp_${Date.now()}.jpg`; l.href=URL.createObjectURL(b); l.click();
                    downloadFinalBtn.textContent=oT; downloadFinalBtn.disabled=false;
                }
            }, 'image/jpeg', q);
        })(1.0);
    });

    draw(); 
</script>







